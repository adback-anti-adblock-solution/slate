
<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta content="IE=edge,chrome=1" http-equiv="X-UA-Compatible">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <title>AdBack API Reference</title>
    <link href="images/favicon.ico" rel="icon" type="image/ico" />

    <style>
      .highlight table td { padding: 5px; }
.highlight table pre { margin: 0; }
.highlight .gh {
  color: #999999;
}
.highlight .sr {
  color: #f6aa11;
}
.highlight .go {
  color: #888888;
}
.highlight .gp {
  color: #555555;
}
.highlight .gs {
}
.highlight .gu {
  color: #aaaaaa;
}
.highlight .nb {
  color: #f6aa11;
}
.highlight .cm {
  color: #75715e;
}
.highlight .cp {
  color: #75715e;
}
.highlight .c1 {
  color: #75715e;
}
.highlight .cs {
  color: #75715e;
}
.highlight .c, .highlight .cd {
  color: #75715e;
}
.highlight .err {
  color: #960050;
}
.highlight .gr {
  color: #960050;
}
.highlight .gt {
  color: #960050;
}
.highlight .gd {
  color: #49483e;
}
.highlight .gi {
  color: #49483e;
}
.highlight .ge {
  color: #49483e;
}
.highlight .kc {
  color: #66d9ef;
}
.highlight .kd {
  color: #66d9ef;
}
.highlight .kr {
  color: #66d9ef;
}
.highlight .no {
  color: #66d9ef;
}
.highlight .kt {
  color: #66d9ef;
}
.highlight .mf {
  color: #ae81ff;
}
.highlight .mh {
  color: #ae81ff;
}
.highlight .il {
  color: #ae81ff;
}
.highlight .mi {
  color: #ae81ff;
}
.highlight .mo {
  color: #ae81ff;
}
.highlight .m, .highlight .mb, .highlight .mx {
  color: #ae81ff;
}
.highlight .sc {
  color: #ae81ff;
}
.highlight .se {
  color: #ae81ff;
}
.highlight .ss {
  color: #ae81ff;
}
.highlight .sd {
  color: #e6db74;
}
.highlight .s2 {
  color: #e6db74;
}
.highlight .sb {
  color: #e6db74;
}
.highlight .sh {
  color: #e6db74;
}
.highlight .si {
  color: #e6db74;
}
.highlight .sx {
  color: #e6db74;
}
.highlight .s1 {
  color: #e6db74;
}
.highlight .s {
  color: #e6db74;
}
.highlight .na {
  color: #a6e22e;
}
.highlight .nc {
  color: #a6e22e;
}
.highlight .nd {
  color: #a6e22e;
}
.highlight .ne {
  color: #a6e22e;
}
.highlight .nf {
  color: #a6e22e;
}
.highlight .vc {
  color: #ffffff;
}
.highlight .nn {
  color: #ffffff;
}
.highlight .nl {
  color: #ffffff;
}
.highlight .ni {
  color: #ffffff;
}
.highlight .bp {
  color: #ffffff;
}
.highlight .vg {
  color: #ffffff;
}
.highlight .vi {
  color: #ffffff;
}
.highlight .nv {
  color: #ffffff;
}
.highlight .w {
  color: #ffffff;
}
.highlight {
  color: #ffffff;
}
.highlight .n, .highlight .py, .highlight .nx {
  color: #ffffff;
}
.highlight .ow {
  color: #f92672;
}
.highlight .nt {
  color: #f92672;
}
.highlight .k, .highlight .kv {
  color: #f92672;
}
.highlight .kn {
  color: #f92672;
}
.highlight .kp {
  color: #f92672;
}
.highlight .o {
  color: #f92672;
}
    </style>
    <link href="stylesheets/screen.css" rel="stylesheet" media="screen" />
    <link href="stylesheets/print.css" rel="stylesheet" media="print" />
      <script src="javascripts/all.js"></script>
  </head>

  <body class="index" data-languages="[&quot;php&quot;,&quot;python&quot;,&quot;ruby&quot;,&quot;shell&quot;,&quot;twig&quot;,&quot;java&quot;]">
    <a href="#" id="nav-button">
      <span>
        NAV
        <img src="images/navbar.png" alt="Navbar" />
      </span>
    </a>
    <div class="toc-wrapper">
      <img src="images/logo.png" class="logo" alt="Logo" />
        <div class="lang-selector">
              <a href="#" data-language-name="php">php</a>
              <a href="#" data-language-name="python">python</a>
              <a href="#" data-language-name="ruby">ruby</a>
              <a href="#" data-language-name="shell">shell</a>
              <a href="#" data-language-name="twig">twig</a>
              <a href="#" data-language-name="java">java</a>
        </div>
        <div class="search">
          <input type="text" class="search" id="input-search" placeholder="Search">
        </div>
        <ul class="search-results"></ul>
      <div id="toc" class="toc-list-h1">
          <li>
            <a href="#introduction" class="toc-h1 toc-link" data-title="Introduction">Introduction</a>
              <ul class="toc-list-h2">
                  <li>
                    <a href="#how-it-works" class="toc-h2 toc-link" data-title="Introduction">How it works ?</a>
                  </li>
              </ul>
          </li>
          <li>
            <a href="#adback-proxy-1st-party-analytics-amp-monetization" class="toc-h1 toc-link" data-title="AdBack Proxy (1st Party Analytics &amp; Monetization)">AdBack Proxy (1st Party Analytics &amp; Monetization)</a>
              <ul class="toc-list-h2">
                  <li>
                    <a href="#1-configure-cron-update-file" class="toc-h2 toc-link" data-title="AdBack Proxy (1st Party Analytics &amp; Monetization)">1) Configure cron update file</a>
                  </li>
                  <li>
                    <a href="#2-integrate-adback-full-script-in-your-pages" class="toc-h2 toc-link" data-title="AdBack Proxy (1st Party Analytics &amp; Monetization)">2) Integrate AdBack full script in your pages</a>
                  </li>
                  <li>
                    <a href="#3-configure-proxy-endpoint" class="toc-h2 toc-link" data-title="AdBack Proxy (1st Party Analytics &amp; Monetization)">3) Configure proxy endpoint</a>
                  </li>
              </ul>
          </li>
          <li>
            <a href="#adback-api-3rd-party-analytics-only" class="toc-h1 toc-link" data-title="AdBack API (3rd Party Analytics only)">AdBack API (3rd Party Analytics only)</a>
              <ul class="toc-list-h2">
                  <li>
                    <a href="#1-get-script-names-and-url" class="toc-h2 toc-link" data-title="AdBack API (3rd Party Analytics only)">1) Get script names and URL</a>
                  </li>
                  <li>
                    <a href="#2-analytics-script" class="toc-h2 toc-link" data-title="AdBack API (3rd Party Analytics only)">2) Analytics script</a>
                  </li>
              </ul>
          </li>
          <li>
            <a href="#script-informations" class="toc-h1 toc-link" data-title="Script informations">Script informations</a>
              <ul class="toc-list-h2">
                  <li>
                    <a href="#message-script" class="toc-h2 toc-link" data-title="Script informations">Message script</a>
                  </li>
                  <li>
                    <a href="#product-flow-script" class="toc-h2 toc-link" data-title="Script informations">Product flow script</a>
                  </li>
                  <li>
                    <a href="#iab-banner-script" class="toc-h2 toc-link" data-title="Script informations">IAB banner script</a>
                  </li>
              </ul>
          </li>
      </div>
        <ul class="toc-footer">
            <li><a href='https://www.adback.co/en/register/'>Sign Up for a Developer token</a></li>
            <li><a href='https://www.adback.co/en/admin/api/'>Claim your token here, must be logged</a></li>
            <li><a href='https://github.com/tripit/slate'>Documentation Powered by Slate</a></li>
        </ul>
    </div>
    <div class="page-wrapper">
      <div class="dark-box"></div>
      <div class="content">
        <h1 id='introduction'>Introduction</h1>
<p>Welcome to the AdBack API documentation! You can use our API to access AdBack API endpoints, which can get non blockable URL and names for your analytics tags.</p>

<p>We have language bindings in PHP, Shell, Ruby, Java, and Python! You can view code examples in the dark area to the right, and you can switch the programming language of the examples with the tabs in the top right.</p>

<p>To fight back Adblock Easylist maintainers who chose to completely block any third party script on some websites, AdBack needs to change the way it has been working till now.</p>

<p>The main issue is that the use of dummy domains and encrypted data has led Easylist to block everything that isn’t related to particular website, as they couldn’t find a way to block only AdBack. </p>

<p>So, to recover its full capacities, AdBack needs to be a part of the only domain that is not blockable without damaging your website&#39;s’ functionality: your website domain.</p>
<h2 id='how-it-works'>How it works ?</h2>
<p>To do that, we must work together to bring AdBack into your infrastructure. These changes are divided into 3 steps:</p>

<ul>
<li><p>Integrating the full AdBack script into your page</p></li>
<li><p>Adding an endpoint for AdBack scripts</p></li>
<li><p>Acting as a proxy to transmit the AdBack data from your page to our servers through your infrastructure</p></li>
</ul>

<p><img src="images/proxy_how.png" alt="AdBack schema" /></p>
<h3 id='1-integrate-adback-full-script-in-your-pages'>1) Integrate AdBack full script in your pages</h3>
<p>Instead of integrating a simple script that calls the full one, you will need to add the full AdBack script to your page. Thus the first calls are not blockable, as they are part of the page code.</p>

<p>This full script needs to be served by your servers, stored in cache for few hours, and updated regularly from our latest available scripts on AdBack servers API. </p>

<p>For example: a cron every 3 hours storing the script in a Redis cache will do it well.</p>
<h3 id='2-adding-an-endpoint-for-adback-scripts'>2) Adding an endpoint for AdBack scripts</h3>
<p>The way AdBack is working: it needs to communicate with our servers to compute data, get correct scripts data, and serve related ads. As external calls could be blocked, we need to get this data through your servers, through an endpoint designed specifically for AdBack.</p>

<p>This endpoint needs to be a part of your website, on your main domain, and not on a subdomain as it could be easily blocked. As well, the endpoint url must be on the top level of your domain as an url pattern could be blocked as well.</p>

<p>For example, if your website is hosted on https://www.website.com, the best endpoint format could be https://www.website.com/randomword. </p>

<p>To add an extra layer of security, we could plan an automatic endpoint name change, like would do Google Authenticator, preventing Adblock to block this call.</p>

<p>The script name in the generated script will be as well modified in a way it should not appear directly, as it could be automatically found and blocked by a regexp using tool.</p>
<h3 id='3-acting-as-a-proxy'>3) Acting as a proxy</h3>
<p>With the help of the newly created endpoint, we will gather data from your AdBlock users, send it to this endpoint and, through your servers, transmit it back to our AdBack servers. The response will be also returned to the user through your server after processing.</p>

<aside class="info">AdBack proxy is an experimental feature that require activation from an AdBack administrator. If you want to use our proxy feature, please contact us at "support@adback.co".</aside>
<h1 id='adback-proxy-1st-party-analytics-amp-monetization'>AdBack Proxy (1st Party Analytics &amp; Monetization)</h1>
<p>To ensure a full AdBack experience where you would not be worried about AdBlock blocking third party scripts (and so your recovered ads), we recommend using a first party install (with proxy).</p>

<p>This way all calls will belong to you domain and could not be easily blocked.</p>

<p>Please follow these steps to install AdBack using proxy.</p>
<h2 id='1-configure-cron-update-file'>1) Configure cron update file</h2>
<blockquote>
<p>sample script</p>
</blockquote>
<pre class="highlight php tab-php"><code><span class="cp">&lt;?php</span>

<span class="cm">/* here we use redis to cache api requests */</span>
<span class="nv">$cache</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Redis</span><span class="p">();</span>
<span class="nv">$cache</span><span class="o">-&gt;</span><span class="na">connect</span><span class="p">(</span><span class="s1">'host'</span><span class="p">);</span>

<span class="nv">$json</span> <span class="o">=</span> <span class="nb">json_decode</span><span class="p">(</span><span class="nb">file_get_contents</span><span class="p">(</span><span class="s1">'https://adback.co/api/script/me/full?access_token=[token]'</span><span class="p">),</span> <span class="kc">true</span><span class="p">);</span>
<span class="sd">/** @var array $scriptElements */</span>
<span class="k">foreach</span> <span class="p">(</span><span class="nv">$json</span><span class="p">[</span><span class="s1">'script_codes'</span><span class="p">]</span> <span class="k">as</span> <span class="nv">$type</span> <span class="o">=&gt;</span> <span class="nv">$data</span><span class="p">)</span> <span class="p">{</span>
    <span class="nv">$cache</span><span class="o">-&gt;</span><span class="na">hSet</span><span class="p">(</span><span class="s1">'adback_proxy'</span><span class="p">,</span> <span class="nv">$type</span><span class="o">.</span><span class="s1">'_code'</span><span class="p">,</span> <span class="nv">$data</span><span class="p">[</span><span class="s1">'code'</span><span class="p">]);</span>
<span class="p">}</span>
<span class="nv">$cache</span><span class="o">-&gt;</span><span class="na">expire</span><span class="p">(</span><span class="s1">'adback_proxy'</span><span class="p">,</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">6</span><span class="p">);</span>
</code></pre><pre class="highlight python tab-python"><code><span class="kn">import</span> <span class="nn">redis</span>
<span class="kn">import</span> <span class="nn">requests</span>

<span class="s">'''here we use redis to cache api requests'''</span>
<span class="n">r_server</span> <span class="o">=</span> <span class="n">redis</span><span class="o">.</span><span class="n">Redis</span><span class="p">(</span><span class="s">'host'</span><span class="p">,</span> <span class="s">'port'</span><span class="p">)</span>
<span class="n">script_elements</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">'https://adback.co/api/script/me/full?access_token=[token]'</span><span class="p">)</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
<span class="k">for</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span> <span class="ow">in</span> <span class="n">script_elements</span><span class="p">[</span><span class="s">'script_codes'</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="n">r_server</span><span class="o">.</span><span class="n">hset</span><span class="p">(</span><span class="s">'adback_proxy'</span><span class="p">,</span> <span class="n">key</span><span class="o">+</span><span class="s">'_code'</span><span class="p">,</span> <span class="n">value</span><span class="p">[</span><span class="s">'code'</span><span class="p">]</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s">"utf8"</span><span class="p">))</span>
<span class="n">r_server</span><span class="o">.</span><span class="n">expire</span><span class="p">(</span><span class="s">'adback_proxy'</span><span class="p">,</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">6</span><span class="p">)</span>

</code></pre><pre class="highlight java tab-java"><code><span class="n">Please</span> <span class="n">contact</span> <span class="n">our</span> <span class="n">support</span> <span class="n">team</span> <span class="n">at</span> <span class="s">"support@adback.co"</span> <span class="n">to</span> <span class="n">configure</span> <span class="n">adback</span> <span class="n">with</span> <span class="n">Java</span>
</code></pre><pre class="highlight ruby tab-ruby"><code><span class="nb">require</span> <span class="s2">"redis"</span>
<span class="nb">require</span> <span class="s2">"json"</span>
<span class="nb">require</span> <span class="s1">'open-uri'</span>

<span class="c1"># here we use redis to cache api requests</span>
<span class="n">cache</span> <span class="o">=</span> <span class="no">Redis</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="ss">:host</span> <span class="o">=&gt;</span> <span class="s2">"HOST"</span><span class="p">)</span>
<span class="n">script</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s1">'https://adback.co/api/script/me/full?access_token=[token]'</span><span class="p">).</span><span class="nf">read</span>
<span class="n">script_elements</span> <span class="o">=</span> <span class="no">JSON</span><span class="p">.</span><span class="nf">parse</span><span class="p">(</span><span class="n">script</span><span class="p">)</span>
<span class="n">script_elements</span><span class="p">[</span><span class="s1">'script_codes'</span><span class="p">].</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="o">|</span>
  <span class="n">cache</span><span class="p">.</span><span class="nf">hset</span><span class="p">(</span><span class="s1">'adback_proxy'</span><span class="p">,</span> <span class="n">key</span><span class="o">+</span><span class="s1">'_code'</span><span class="p">,</span> <span class="n">value</span><span class="p">[</span><span class="s1">'code'</span><span class="p">])</span>
<span class="k">end</span>
<span class="n">cache</span><span class="p">.</span><span class="nf">expire</span><span class="p">(</span><span class="s1">'adback_proxy'</span><span class="p">,</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">6</span><span class="p">)</span>
</code></pre><pre class="highlight shell tab-shell"><code><span class="c"># curl command</span>

curl -X <span class="s2">"GET"</span> <span class="s1">'https://adback.co/api/script/me/full?access_token="token"'</span>
</code></pre><pre class="highlight twig tab-twig"><code># Launch the Symfony command to refesh the tags

$ php app/console adback:api-client:refresh-tag
</code></pre>
<blockquote>
<p>The above API call returns JSON structured like this:</p>
</blockquote>
<pre class="highlight json tab-json"><code><span class="p">{</span><span class="w">
    </span><span class="s2">"script_codes"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="s2">"analytics"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
            </span><span class="s2">"script_name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"scriptname"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"analytics"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"code"</span><span class="p">:</span><span class="w"> </span><span class="s2">"(function e(t,n,r){...})"</span><span class="w">
        </span><span class="p">},</span><span class="w">
        </span><span class="s2">"message"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
            </span><span class="s2">"script_name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"scriptname"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"message"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"code"</span><span class="p">:</span><span class="w"> </span><span class="s2">"(function e(t,n,r){...})"</span><span class="w">
        </span><span class="p">},</span><span class="w">
        </span><span class="s2">"catcher"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
            </span><span class="s2">"script_name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"scriptname"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"catcher"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"code"</span><span class="p">:</span><span class="w"> </span><span class="s2">"(function e(t,n,r){...})"</span><span class="w">
        </span><span class="p">},</span><span class="w">
        </span><span class="s2">"product"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
            </span><span class="s2">"script_name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"scriptname"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"product"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"code"</span><span class="p">:</span><span class="w"> </span><span class="s2">"(function e(t,n,r){...})"</span><span class="w">
        </span><span class="p">},</span><span class="w">
        </span><span class="s2">"iab_banner"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
            </span><span class="s2">"script_name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"scriptname"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"iab_banner"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"code"</span><span class="p">:</span><span class="w"> </span><span class="s2">"(function e(t,n,r){...})"</span><span class="w">
        </span><span class="p">}</span><span class="w">
    </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre>
<p>In order for the scripts to be updated, you must run a script regularly that will get the script code from our AdBack servers and store it in your cache system. You will find there examples on how to do it with different technologies.</p>
<h3 id='code-logic'>Code logic:</h3>
<ul>
<li><p>connect to your cache provider to limit api calls (here Redis)</p></li>
<li><p>call AdBack API to get tags information </p></li>
<li><p>cache all information</p></li>
<li><p>set cache expiry time to 6 hours</p></li>
</ul>
<h3 id='http-request'>HTTP Request:</h3>
<p><code>GET https://adback.co/api/script/me/full</code></p>
<h3 id='query-parameters'>Query Parameters:</h3>
<table><thead>
<tr>
<th>Parameter</th>
<th>Required</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td>access_token</td>
<td>Yes</td>
<td>Personal token for authentication, <a href="https://www.adback.co/en/admin/api/">here</a> you can get your token</td>
</tr>
</tbody></table>

<aside class="warning">You should setup cron task or service to refresh tag every 6 hours</aside>
<h2 id='2-integrate-adback-full-script-in-your-pages'>2) Integrate AdBack full script in your pages</h2>
<blockquote>
<p>Sample script:</p>
</blockquote>
<pre class="highlight php tab-php"><code>
<span class="cp">&lt;?php</span>
<span class="cm">/* here we use redis to cache api requests */</span>
<span class="nv">$cache</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Redis</span><span class="p">();</span>
<span class="nv">$cache</span><span class="o">-&gt;</span><span class="na">connect</span><span class="p">(</span><span class="s1">'host'</span><span class="p">,</span> <span class="s1">'port'</span><span class="p">);</span>

<span class="nv">$analyticsScriptCode</span> <span class="o">=</span> <span class="s1">''</span><span class="p">;</span>
<span class="k">if</span> <span class="p">(</span><span class="nv">$cache</span><span class="o">-&gt;</span><span class="na">has</span><span class="p">(</span><span class="s1">'adback_proxy'</span><span class="p">))</span> <span class="p">{</span>
    <span class="nv">$codes</span> <span class="o">=</span> <span class="nv">$cache</span><span class="o">-&gt;</span><span class="na">hGetAll</span><span class="p">(</span><span class="s1">'adback_proxy'</span><span class="p">);</span>
    <span class="k">foreach</span> <span class="p">(</span><span class="nv">$codes</span> <span class="k">as</span> <span class="nv">$code</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="cm">/* display tag */</span>
        <span class="k">echo</span> <span class="s2">"&lt;script&gt;</span><span class="nv">$code</span><span class="s2">&lt;/script&gt;"</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre><pre class="highlight python tab-python"><code><span class="kn">import</span> <span class="nn">redis</span>
<span class="kn">import</span> <span class="nn">requests</span>

<span class="s">'''here we use redis to cache api requests'''</span>
<span class="n">r_server</span> <span class="o">=</span> <span class="n">redis</span><span class="o">.</span><span class="n">Redis</span><span class="p">(</span><span class="s">'host'</span><span class="p">,</span> <span class="s">'port'</span><span class="p">)</span>
<span class="k">if</span> <span class="n">r_server</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="s">'adback_proxy'</span><span class="p">):</span>
    <span class="n">codes</span> <span class="o">=</span> <span class="n">r_server</span><span class="o">.</span><span class="n">hgetall</span><span class="p">(</span><span class="s">'adback_proxy'</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">code</span> <span class="ow">in</span> <span class="n">codes</span><span class="p">:</span>
        <span class="k">print</span> <span class="s">"&lt;script&gt;"</span> <span class="o">+</span> <span class="n">code</span> <span class="o">+</span> <span class="s">"&lt;/script&gt;"</span>
</code></pre><pre class="highlight java tab-java"><code><span class="n">Please</span> <span class="n">contact</span> <span class="n">our</span> <span class="n">support</span> <span class="n">team</span> <span class="n">at</span> <span class="s">"support@adback.co"</span> <span class="n">to</span> <span class="n">configure</span> <span class="n">adback</span> <span class="n">with</span> <span class="n">Java</span>
</code></pre><pre class="highlight ruby tab-ruby"><code><span class="nb">require</span> <span class="s2">"redis"</span>
<span class="nb">require</span> <span class="s1">'open-uri'</span>

<span class="c1"># here we use redis to cache api requests</span>
<span class="n">cache</span> <span class="o">=</span> <span class="no">Redis</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="ss">:host</span> <span class="o">=&gt;</span> <span class="s2">"HOST"</span><span class="p">)</span>
<span class="k">if</span> <span class="n">cache</span><span class="p">.</span><span class="nf">exists</span><span class="p">(</span><span class="s1">'adback_proxy'</span><span class="p">)</span>
  <span class="n">codes</span> <span class="o">=</span> <span class="n">cache</span><span class="p">.</span><span class="nf">hgetall</span><span class="p">(</span><span class="s1">'adback_proxy'</span><span class="p">);</span>
  <span class="k">for</span> <span class="n">code</span> <span class="k">in</span> <span class="n">codes</span>
    <span class="nb">puts</span> <span class="s2">"&lt;script&gt;</span><span class="si">#{</span><span class="n">code</span><span class="si">}</span><span class="s2">&lt;/script&gt;"</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre><pre class="highlight shell tab-shell"><code><span class="c"># bash script to test api consumption</span>
<span class="gp">$ </span>wget https://raw.githubusercontent.com/adback-anti-adblock-solution/adback-bash-refresh/master/adback-refresh-tags

<span class="gp">$ </span>chmod +x adback-refresh-tags

<span class="c"># display product flow tag with option -p and -html</span>
<span class="gp">$ </span>./adback-refresh-tags <span class="s2">"token"</span> -p -html
</code></pre><pre class="highlight twig tab-twig"><code><span class="cp">{{</span> <span class="nv">adback_generate_scripts</span><span class="p">()</span> <span class="cp">}}</span>
</code></pre>
<p>You must use your favorite tools or template engine to recover the script code from the previous step and insert it into your page.</p>
<h3 id='code-logic-2'>Code logic:</h3>
<ul>
<li><p>connect to your cache provider (here Redis)</p></li>
<li><p>get scripts codes</p></li>
<li><p>generate and display tag</p></li>
</ul>

<aside class="warning">You should not include our script in your error pages (404, 500, etc) or you might create an error loop if your proxy endpoint is not defined.</aside>
<h2 id='3-configure-proxy-endpoint'>3) Configure proxy endpoint</h2>
<aside class="info">
You have 2 ways of installing the proxy: with a script file (Php, etc), or configuring your current web server (nginx, Apache2, Varnish) to act as a proxy.

If you are confident with editing server configuration, we recommend using it, otherwise, or if your infrastructure does not allow it, please use the script.
</aside>

<blockquote>
<p>Using your webserver</p>

<p>Nginx</p>
</blockquote>
<pre class="highlight nginx tab-nginx"><code><span class="k">location</span> <span class="n">/proxyname</span> <span class="p">{</span>
    <span class="kn">proxy_set_header</span> <span class="s">Host</span> <span class="nv">$http_host</span><span class="p">;</span>
    <span class="kn">proxy_set_header</span> <span class="s">X-Real-IP</span> <span class="nv">$remote_addr</span><span class="p">;</span>
    <span class="kn">proxy_set_header</span> <span class="s">X-Forwarded-For</span> <span class="nv">$proxy_add_x_forwarded_for</span><span class="p">;</span>
    <span class="kn">rewrite</span> <span class="s">^/proxy/(.*)</span>$ <span class="n">/proxyname.js/</span><span class="nv">$1</span> <span class="s">break</span><span class="p">;</span>
    <span class="kn">proxy_pass</span> <span class="s">http://hosted.adback.co</span><span class="p">;</span>
<span class="p">}</span>
</code></pre>
<blockquote>
<p>Apache 2</p>
</blockquote>
<pre class="highlight plaintext"><code>ProxyPreserveHost On
ProxyRequests Off
ProxyAddHeaders On
ProxyPass /proxyname http://hosted.adback.co/scriptname.js
ProxyPassReverse /proxyname  http://hosted.adback.co/scriptname.js
</code></pre>
<blockquote>
<p>Varnish</p>
</blockquote>
<pre class="highlight plaintext"><code># Backend definition linked to AdBack
backend adback {
    .host                  = "hosted.adback.co";
    .port                  = "80";
    .first_byte_timeout    = 120s;
    .connect_timeout       = 20s;
    .between_bytes_timeout = 40s;
}

sub vcl_recv {
    if(req.url ~ "^/(proxyname)/.*$"){
        set req.backend_hint = adback;
        set req.http.Host = "kapowsingardnerville.heatonnikolski.com";
        set req.url = regsub(req.url, "^/(proxyname)/", "/varnish.js/");

        return(pipe);
    }
}
</code></pre>
<blockquote>
<p>Sample script:</p>
</blockquote>
<pre class="highlight php tab-php"><code>//proxy.php
<span class="cp">&lt;?php</span>

<span class="cm">/*
 * Configuration
 */</span>

<span class="c1">// Destination URL: Where this proxy leads to.
// Replace scriptname.js with one of your endpoints !
</span><span class="nv">$destinationURL</span> <span class="o">=</span> <span class="s1">'http://hosted.adback.co/scriptname.js'</span><span class="p">;</span>

<span class="cm">/*--------------------------------------------------------------/
| PROXY.PHP                                                     |
| Created By: Évelyne Lachance                                  |
| Contact: eslachance@gmail.com                                 |
| Source: http://github.com/eslachance/php-transparent-proxy    |
| Description: This proxy does a POST or GET request from any   |
|         page on the authorized domain to the defined URL      |
/--------------------------------------------------------------*/</span>

<span class="c1">// Credits to Chris Hope (http://www.electrictoolbox.com/chris-hope/) for this function.
// http://www.electrictoolbox.com/php-get-headers-sent-from-browser/
</span><span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">function_exists</span><span class="p">(</span><span class="s1">'getallheaders'</span><span class="p">))</span> <span class="p">{</span>
    <span class="k">function</span> <span class="nf">getallheaders</span><span class="p">()</span> <span class="p">{</span>
        <span class="nv">$headers</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span>
        <span class="k">foreach</span> <span class="p">(</span><span class="nv">$_SERVER</span> <span class="k">as</span> <span class="nv">$key</span> <span class="o">=&gt;</span> <span class="nv">$value</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="nb">substr</span><span class="p">(</span><span class="nv">$key</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span> <span class="o">==</span> <span class="s1">'HTTP_'</span><span class="p">)</span> <span class="p">{</span>
                <span class="nv">$headers</span><span class="p">[</span><span class="nb">str_replace</span><span class="p">(</span><span class="s1">' '</span><span class="p">,</span> <span class="s1">'-'</span><span class="p">,</span> <span class="nb">ucwords</span><span class="p">(</span><span class="nb">str_replace</span><span class="p">(</span><span class="s1">'_'</span><span class="p">,</span> <span class="s1">' '</span><span class="p">,</span> <span class="nb">strtolower</span><span class="p">(</span><span class="nb">substr</span><span class="p">(</span><span class="nv">$key</span><span class="p">,</span> <span class="mi">5</span><span class="p">)))))]</span> <span class="o">=</span> <span class="nv">$value</span><span class="p">;</span>
            <span class="p">}</span> <span class="k">elseif</span> <span class="p">(</span><span class="nv">$key</span> <span class="o">==</span> <span class="s1">'CONTENT_TYPE'</span><span class="p">)</span> <span class="p">{</span>
                <span class="nv">$headers</span><span class="p">[</span><span class="nb">str_replace</span><span class="p">(</span><span class="s1">' '</span><span class="p">,</span> <span class="s1">'-'</span><span class="p">,</span> <span class="nb">ucwords</span><span class="p">(</span><span class="nb">str_replace</span><span class="p">(</span><span class="s1">'_'</span><span class="p">,</span> <span class="s1">' '</span><span class="p">,</span> <span class="nb">strtolower</span><span class="p">(</span><span class="nv">$key</span><span class="p">))))]</span> <span class="o">=</span> <span class="nv">$value</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="nv">$headers</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
<span class="c1">// Figure out requester's IP to ship it to X-Forwarded-For
</span><span class="nv">$ip</span> <span class="o">=</span> <span class="s1">''</span><span class="p">;</span>
<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_SERVER</span><span class="p">[</span><span class="s1">'HTTP_CLIENT_IP'</span><span class="p">]))</span> <span class="p">{</span>
    <span class="nv">$ip</span> <span class="o">=</span> <span class="nv">$_SERVER</span><span class="p">[</span><span class="s1">'HTTP_CLIENT_IP'</span><span class="p">];</span>
<span class="p">}</span> <span class="k">elseif</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_SERVER</span><span class="p">[</span><span class="s1">'HTTP_X_FORWARDED_FOR'</span><span class="p">]))</span> <span class="p">{</span>
    <span class="nv">$ip</span> <span class="o">=</span> <span class="nv">$_SERVER</span><span class="p">[</span><span class="s1">'HTTP_X_FORWARDED_FOR'</span><span class="p">];</span>
<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="nv">$ip</span> <span class="o">=</span> <span class="nv">$_SERVER</span><span class="p">[</span><span class="s1">'REMOTE_ADDR'</span><span class="p">];</span>
<span class="p">}</span>

<span class="nv">$currentUrl</span> <span class="o">=</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_SERVER</span><span class="p">[</span><span class="s1">'HTTPS'</span><span class="p">])</span> <span class="o">&amp;&amp;</span> <span class="nv">$_SERVER</span><span class="p">[</span><span class="s1">'HTTPS'</span><span class="p">]</span> <span class="o">!==</span> <span class="s1">'off'</span> <span class="o">?</span> <span class="s1">'https'</span> <span class="o">:</span> <span class="s1">'http'</span> <span class="p">)</span><span class="o">.</span> <span class="s2">"://</span><span class="si">{</span><span class="nv">$_SERVER</span><span class="p">[</span><span class="s1">'HTTP_HOST'</span><span class="p">]</span><span class="si">}{</span><span class="nv">$_SERVER</span><span class="p">[</span><span class="s1">'REQUEST_URI'</span><span class="p">]</span><span class="si">}</span><span class="s2">"</span><span class="p">;</span>

<span class="nv">$params</span> <span class="o">=</span> <span class="s1">''</span><span class="p">;</span>
<span class="k">if</span> <span class="p">(</span><span class="nb">preg_match</span><span class="p">(</span><span class="nb">sprintf</span><span class="p">(</span><span class="s1">'#/%s(?&lt;params&gt;/.+)#'</span><span class="p">,</span> <span class="nb">preg_quote</span><span class="p">(</span><span class="nb">basename</span><span class="p">(</span><span class="nv">$_SERVER</span><span class="p">[</span><span class="s2">"SCRIPT_FILENAME"</span><span class="p">]),</span> <span class="s1">'#'</span><span class="p">)),</span> <span class="nv">$currentUrl</span><span class="p">,</span> <span class="nv">$matches</span><span class="p">))</span> <span class="p">{</span>
    <span class="nv">$params</span> <span class="o">=</span> <span class="nv">$matches</span><span class="p">[</span><span class="s1">'params'</span><span class="p">];</span>
<span class="p">}</span> <span class="k">elseif</span> <span class="p">(</span><span class="nb">preg_match</span><span class="p">(</span><span class="nb">sprintf</span><span class="p">(</span><span class="s1">'#/%s(?&lt;params&gt;/.+)#'</span><span class="p">,</span> <span class="nb">preg_quote</span><span class="p">(</span><span class="nb">basename</span><span class="p">(</span><span class="nv">$_SERVER</span><span class="p">[</span><span class="s2">"SCRIPT_NAME"</span><span class="p">]),</span> <span class="s1">'#'</span><span class="p">)),</span> <span class="nv">$currentUrl</span><span class="p">,</span> <span class="nv">$matches</span><span class="p">))</span> <span class="p">{</span>
    <span class="nv">$params</span> <span class="o">=</span> <span class="nv">$matches</span><span class="p">[</span><span class="s1">'params'</span><span class="p">];</span>
<span class="p">}</span>

<span class="nv">$_SERVER</span><span class="p">[</span><span class="s1">'HTTP_REFERER'</span><span class="p">]</span> <span class="o">=</span> <span class="nb">isset</span><span class="p">(</span><span class="nv">$_SERVER</span><span class="p">[</span><span class="s1">'HTTP_REFERER'</span><span class="p">])</span> <span class="o">?</span> <span class="nv">$_SERVER</span><span class="p">[</span><span class="s1">'HTTP_REFERER'</span><span class="p">]</span> <span class="o">:</span> <span class="nv">$currentUrl</span><span class="p">;</span>

<span class="nv">$method</span> <span class="o">=</span> <span class="nv">$_SERVER</span><span class="p">[</span><span class="s1">'REQUEST_METHOD'</span><span class="p">];</span>
<span class="k">if</span> <span class="p">(</span><span class="nv">$method</span> <span class="o">==</span> <span class="s2">"GET"</span><span class="p">)</span> <span class="p">{</span>
    <span class="nv">$data</span><span class="o">=</span><span class="nv">$_GET</span><span class="p">;</span>
<span class="p">}</span> <span class="k">elseif</span> <span class="p">(</span><span class="nv">$method</span><span class="o">==</span><span class="s2">"POST"</span> <span class="o">&amp;&amp;</span> <span class="nb">count</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
    <span class="nv">$data</span><span class="o">=</span><span class="nv">$_POST</span><span class="p">;</span>
<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="nv">$data</span> <span class="o">=</span> <span class="nb">file_get_contents</span><span class="p">(</span><span class="s2">"php://input"</span><span class="p">);</span>
<span class="p">}</span>
<span class="nv">$response</span> <span class="o">=</span> <span class="nx">proxy_request</span><span class="p">(</span><span class="nv">$destinationURL</span><span class="p">,</span> <span class="nv">$data</span><span class="p">,</span> <span class="nv">$method</span><span class="p">,</span> <span class="nv">$params</span><span class="p">,</span> <span class="nv">$ip</span><span class="p">);</span>
<span class="nv">$headerArray</span> <span class="o">=</span> <span class="nb">explode</span><span class="p">(</span><span class="s2">"</span><span class="se">\r\n</span><span class="s2">"</span><span class="p">,</span> <span class="nv">$response</span><span class="p">[</span><span class="s1">'header'</span><span class="p">]);</span>
<span class="nv">$is_chunked</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
<span class="k">foreach</span><span class="p">(</span><span class="nv">$headerArray</span> <span class="k">as</span> <span class="nv">$headerLine</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nb">strtolower</span><span class="p">(</span><span class="nv">$headerLine</span><span class="p">)</span> <span class="o">==</span> <span class="s2">"transfer-encoding: chunked"</span><span class="p">)</span> <span class="p">{</span>
        <span class="nv">$is_chunked</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
<span class="nv">$contents</span> <span class="o">=</span> <span class="nv">$response</span><span class="p">[</span><span class="s1">'content'</span><span class="p">];</span>
<span class="k">if</span> <span class="p">(</span><span class="nv">$is_chunked</span><span class="p">)</span> <span class="p">{</span>
    <span class="nv">$decodedContents</span> <span class="o">=</span> <span class="o">@</span><span class="nx">decode_chunked</span><span class="p">(</span><span class="nv">$contents</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="nb">strlen</span><span class="p">(</span><span class="nv">$decodedContents</span><span class="p">))</span> <span class="p">{</span>
        <span class="nv">$contents</span> <span class="o">=</span> <span class="nv">$decodedContents</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">foreach</span> <span class="p">(</span><span class="nv">$headerArray</span> <span class="k">as</span> <span class="nv">$header</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span>
        <span class="nb">strpos</span><span class="p">(</span><span class="nb">strtolower</span><span class="p">(</span><span class="nv">$header</span><span class="p">),</span> <span class="s1">'transfer-encoding'</span><span class="p">)</span> <span class="o">===</span> <span class="kc">false</span>
    <span class="p">)</span> <span class="p">{</span>
        <span class="nb">header</span><span class="p">(</span><span class="nv">$header</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">echo</span> <span class="nv">$contents</span><span class="p">;</span>

<span class="k">function</span> <span class="nf">proxy_request</span><span class="p">(</span><span class="nv">$url</span><span class="p">,</span> <span class="nv">$data</span><span class="p">,</span> <span class="nv">$method</span><span class="p">,</span> <span class="nv">$params</span><span class="p">,</span> <span class="nv">$ip</span><span class="p">)</span> <span class="p">{</span>
<span class="c1">// Based on post_request from http://www.jonasjohn.de/snippets/php/post-request.htm
</span>    <span class="nv">$req_dump</span> <span class="o">=</span> <span class="nb">print_r</span><span class="p">(</span><span class="nv">$data</span><span class="p">,</span> <span class="k">TRUE</span><span class="p">);</span>

    <span class="nv">$url</span> <span class="o">=</span> <span class="nb">parse_url</span><span class="p">(</span><span class="nv">$url</span><span class="p">);</span>

    <span class="c1">// Convert the data array into URL Parameters like a=b&amp;foo=bar etc.
</span>    <span class="k">if</span> <span class="p">(</span><span class="nv">$method</span> <span class="o">==</span> <span class="s2">"GET"</span><span class="p">)</span>  <span class="p">{</span>
        <span class="nv">$data</span> <span class="o">=</span> <span class="nb">http_build_query</span><span class="p">(</span><span class="nv">$data</span><span class="p">);</span>

        <span class="c1">// Add GET params from destination URL
</span>        <span class="k">if</span> <span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$parsedUrl</span><span class="p">[</span><span class="s1">'query'</span><span class="p">]))</span> <span class="p">{</span>
            <span class="nv">$data</span> <span class="o">=</span> <span class="nv">$data</span> <span class="o">.</span> <span class="nv">$url</span><span class="p">[</span><span class="s2">"query"</span><span class="p">];</span>
        <span class="p">}</span>
    <span class="p">}</span> <span class="k">elseif</span> <span class="p">(</span><span class="nv">$method</span><span class="o">==</span><span class="s2">"POST"</span> <span class="o">&amp;&amp;</span> <span class="nb">count</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="nv">$data</span> <span class="o">=</span> <span class="nb">http_build_query</span><span class="p">(</span><span class="nv">$data</span><span class="p">);</span>

        <span class="c1">// Add GET params from destination URL
</span>        <span class="k">if</span> <span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$parsedUrl</span><span class="p">[</span><span class="s1">'query'</span><span class="p">]))</span> <span class="p">{</span>
            <span class="nv">$data</span> <span class="o">=</span> <span class="nv">$data</span> <span class="o">.</span> <span class="nv">$url</span><span class="p">[</span><span class="s2">"query"</span><span class="p">];</span>
        <span class="p">}</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nv">$data</span> <span class="o">=</span> <span class="nv">$data</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="nv">$datalength</span> <span class="o">=</span> <span class="nb">strlen</span><span class="p">(</span><span class="nv">$data</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="nv">$url</span><span class="p">[</span><span class="s1">'scheme'</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">'http'</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">die</span><span class="p">(</span><span class="s1">'Error: Only HTTP request are supported !'</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="c1">// extract host and path:
</span>    <span class="nv">$host</span> <span class="o">=</span> <span class="nv">$url</span><span class="p">[</span><span class="s1">'host'</span><span class="p">];</span>
    <span class="nv">$path</span> <span class="o">=</span> <span class="nv">$url</span><span class="p">[</span><span class="s1">'path'</span><span class="p">]</span><span class="o">.</span><span class="nv">$params</span><span class="p">;</span>
    <span class="nv">$port</span> <span class="o">=</span> <span class="nb">isset</span><span class="p">(</span><span class="nv">$url</span><span class="p">[</span><span class="s1">'port'</span><span class="p">])</span> <span class="o">?</span> <span class="nv">$url</span><span class="p">[</span><span class="s1">'port'</span><span class="p">]</span> <span class="o">:</span> <span class="p">(</span><span class="nv">$url</span><span class="p">[</span><span class="s1">'scheme'</span><span class="p">]</span> <span class="o">==</span> <span class="s1">'https'</span> <span class="o">?</span> <span class="s1">'443'</span> <span class="o">:</span> <span class="s1">'80'</span><span class="p">);</span>

    <span class="nv">$fp</span> <span class="o">=</span> <span class="nb">fsockopen</span><span class="p">(</span><span class="nv">$host</span><span class="p">,</span> <span class="nv">$port</span><span class="p">,</span> <span class="nv">$errno</span><span class="p">,</span> <span class="nv">$errstr</span><span class="p">,</span> <span class="mi">30</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="nv">$fp</span><span class="p">){</span>
        <span class="c1">// send the request headers:
</span>        <span class="k">if</span> <span class="p">(</span><span class="nv">$method</span> <span class="o">==</span> <span class="s2">"POST"</span><span class="p">)</span> <span class="p">{</span>
            <span class="nv">$callback</span> <span class="o">=</span> <span class="s2">"POST </span><span class="nv">$path</span><span class="s2"> HTTP/1.1</span><span class="se">\r\n</span><span class="s2">"</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nv">$callback</span> <span class="o">=</span> <span class="s2">"GET </span><span class="nv">$path</span><span class="s2">?</span><span class="nv">$data</span><span class="s2"> HTTP/1.1</span><span class="se">\r\n</span><span class="s2">"</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="nv">$callback</span> <span class="o">.=</span> <span class="s2">"Host: </span><span class="nv">$host</span><span class="se">\r\n</span><span class="s2">"</span><span class="p">;</span>

        <span class="nv">$callback</span> <span class="o">.=</span> <span class="s2">"X-Forwarded-For: </span><span class="nv">$ip</span><span class="se">\r\n</span><span class="s2">"</span><span class="p">;</span>
        <span class="nv">$callback</span> <span class="o">.=</span> <span class="s2">"Accept-Charset: ISO-8859-1,utf-8;q=0.7,*;q=0.7</span><span class="se">\r\n</span><span class="s2">"</span><span class="p">;</span>

        <span class="nv">$requestHeaders</span> <span class="o">=</span> <span class="nb">getallheaders</span><span class="p">();</span>

        <span class="k">foreach</span> <span class="p">(</span><span class="nv">$requestHeaders</span> <span class="k">as</span> <span class="nv">$header</span> <span class="o">=&gt;</span> <span class="nv">$value</span><span class="p">)</span> <span class="p">{</span>
            <span class="nv">$lowerHeader</span> <span class="o">=</span> <span class="nb">strtolower</span><span class="p">(</span><span class="nv">$header</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span>
                <span class="nv">$lowerHeader</span> <span class="o">!==</span> <span class="s2">"connection"</span>
                <span class="o">&amp;&amp;</span> <span class="nv">$lowerHeader</span> <span class="o">!==</span> <span class="s2">"host"</span>
                <span class="o">&amp;&amp;</span> <span class="nv">$lowerHeader</span> <span class="o">!==</span> <span class="s2">"content-length"</span>
                <span class="o">&amp;&amp;</span> <span class="nv">$lowerHeader</span> <span class="o">!==</span> <span class="s2">"content-type"</span>
            <span class="p">)</span> <span class="p">{</span>
                <span class="nv">$callback</span> <span class="o">.=</span> <span class="s2">"</span><span class="nv">$header</span><span class="s2">: </span><span class="nv">$value</span><span class="se">\r\n</span><span class="s2">"</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="p">(</span><span class="nv">$method</span> <span class="o">==</span> <span class="s2">"POST"</span> <span class="o">&amp;&amp;</span> <span class="nb">isset</span><span class="p">(</span><span class="nv">$requestHeaders</span><span class="p">[</span><span class="s1">'Content-Type'</span><span class="p">]))</span> <span class="p">{</span>
            <span class="nv">$callback</span> <span class="o">.=</span> <span class="s2">"Content-Type: "</span><span class="o">.</span><span class="nv">$requestHeaders</span><span class="p">[</span><span class="s1">'Content-Type'</span><span class="p">]</span><span class="o">.</span><span class="s2">"</span><span class="se">\r\n</span><span class="s2">"</span><span class="p">;</span>
            <span class="nv">$callback</span> <span class="o">.=</span> <span class="s2">"Content-length: "</span><span class="o">.</span><span class="nv">$datalength</span><span class="o">.</span><span class="s2">"</span><span class="se">\r\n</span><span class="s2">"</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="nv">$callback</span> <span class="o">.=</span> <span class="s2">"Connection: close</span><span class="se">\r\n\r\n</span><span class="s2">"</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="nv">$datalength</span><span class="p">)</span> <span class="p">{</span>
            <span class="nv">$callback</span> <span class="o">.=</span> <span class="s2">"</span><span class="nv">$data</span><span class="se">\r\n\r\n</span><span class="s2">"</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="nb">fwrite</span><span class="p">(</span><span class="nv">$fp</span><span class="p">,</span> <span class="nv">$callback</span><span class="p">);</span>

        <span class="nv">$result</span> <span class="o">=</span> <span class="s1">''</span><span class="p">;</span>
        <span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="nb">feof</span><span class="p">(</span><span class="nv">$fp</span><span class="p">))</span> <span class="p">{</span>
            <span class="c1">// receive the results of the request
</span>            <span class="nv">$result</span> <span class="o">.=</span> <span class="nb">fgets</span><span class="p">(</span><span class="nv">$fp</span><span class="p">,</span> <span class="mi">128</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="p">{</span>
        <span class="k">return</span> <span class="k">array</span><span class="p">(</span>
            <span class="s1">'status'</span> <span class="o">=&gt;</span> <span class="s1">'err'</span><span class="p">,</span>
            <span class="s1">'error'</span> <span class="o">=&gt;</span> <span class="s2">"</span><span class="nv">$errstr</span><span class="s2"> (</span><span class="nv">$errno</span><span class="s2">)"</span>
        <span class="p">);</span>
    <span class="p">}</span>

    <span class="c1">// close the socket connection:
</span>    <span class="nb">fclose</span><span class="p">(</span><span class="nv">$fp</span><span class="p">);</span>

    <span class="c1">// split the result header from the content
</span>    <span class="nv">$result</span> <span class="o">=</span> <span class="nb">explode</span><span class="p">(</span><span class="s2">"</span><span class="se">\r\n\r\n</span><span class="s2">"</span><span class="p">,</span> <span class="nv">$result</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
    <span class="nv">$header</span> <span class="o">=</span> <span class="nb">isset</span><span class="p">(</span><span class="nv">$result</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">?</span> <span class="nv">$result</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">:</span> <span class="s1">''</span><span class="p">;</span>
    <span class="nv">$content</span> <span class="o">=</span> <span class="nb">isset</span><span class="p">(</span><span class="nv">$result</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">?</span> <span class="nv">$result</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">:</span> <span class="s1">''</span><span class="p">;</span>

    <span class="c1">// return as structured array:
</span>    <span class="k">return</span> <span class="k">array</span><span class="p">(</span>
        <span class="s1">'status'</span> <span class="o">=&gt;</span> <span class="s1">'ok'</span><span class="p">,</span>
        <span class="s1">'header'</span> <span class="o">=&gt;</span> <span class="nv">$header</span><span class="p">,</span>
        <span class="s1">'content'</span> <span class="o">=&gt;</span> <span class="nv">$content</span>
    <span class="p">);</span>
<span class="p">}</span>

<span class="c1">// Credits to @flowfree (http://stackoverflow.com/users/1396314/flowfree) for this function.
// http://stackoverflow.com/questions/10793017/how-to-easily-decode-http-chunked-encoded-string-when-making-raw-http-request
</span><span class="k">function</span> <span class="nf">decode_chunked</span><span class="p">(</span><span class="nv">$str</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">for</span> <span class="p">(</span><span class="nv">$res</span> <span class="o">=</span> <span class="s1">''</span><span class="p">;</span> <span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$str</span><span class="p">);</span> <span class="nv">$str</span> <span class="o">=</span> <span class="nb">trim</span><span class="p">(</span><span class="nv">$str</span><span class="p">))</span> <span class="p">{</span>
        <span class="nv">$pos</span> <span class="o">=</span> <span class="nb">strpos</span><span class="p">(</span><span class="nv">$str</span><span class="p">,</span> <span class="s2">"</span><span class="se">\r\n</span><span class="s2">"</span><span class="p">);</span>
        <span class="nv">$len</span> <span class="o">=</span> <span class="nb">hexdec</span><span class="p">(</span><span class="nb">substr</span><span class="p">(</span><span class="nv">$str</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nv">$pos</span><span class="p">));</span>
        <span class="nv">$res</span><span class="o">.=</span> <span class="nb">substr</span><span class="p">(</span><span class="nv">$str</span><span class="p">,</span> <span class="nv">$pos</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="nv">$len</span><span class="p">);</span>
        <span class="nv">$str</span> <span class="o">=</span> <span class="nb">substr</span><span class="p">(</span><span class="nv">$str</span><span class="p">,</span> <span class="nv">$pos</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">+</span> <span class="nv">$len</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nv">$res</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">?&gt;</span>
</code></pre><pre class="highlight python tab-python"><code><span class="o">//</span><span class="n">proxy2</span><span class="o">.</span><span class="n">py</span> <span class="n">Untested</span> <span class="err">!</span>
<span class="o">//</span> <span class="n">Source</span><span class="p">:</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">github</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">inaz2</span><span class="o">/</span><span class="n">proxy2</span>
<span class="c"># -*- coding: utf-8 -*-</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">socket</span>
<span class="kn">import</span> <span class="nn">ssl</span>
<span class="kn">import</span> <span class="nn">select</span>
<span class="kn">import</span> <span class="nn">httplib</span>
<span class="kn">import</span> <span class="nn">urlparse</span>
<span class="kn">import</span> <span class="nn">threading</span>
<span class="kn">import</span> <span class="nn">gzip</span>
<span class="kn">import</span> <span class="nn">zlib</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">from</span> <span class="nn">BaseHTTPServer</span> <span class="kn">import</span> <span class="n">HTTPServer</span><span class="p">,</span> <span class="n">BaseHTTPRequestHandler</span>
<span class="kn">from</span> <span class="nn">SocketServer</span> <span class="kn">import</span> <span class="n">ThreadingMixIn</span>
<span class="kn">from</span> <span class="nn">cStringIO</span> <span class="kn">import</span> <span class="n">StringIO</span>
<span class="kn">from</span> <span class="nn">subprocess</span> <span class="kn">import</span> <span class="n">Popen</span><span class="p">,</span> <span class="n">PIPE</span>
<span class="kn">from</span> <span class="nn">HTMLParser</span> <span class="kn">import</span> <span class="n">HTMLParser</span>


<span class="k">def</span> <span class="nf">with_color</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">s</span><span class="p">):</span>
    <span class="k">return</span> <span class="s">"</span><span class="se">\x1b</span><span class="s">[</span><span class="si">%</span><span class="s">dm</span><span class="si">%</span><span class="s">s</span><span class="se">\x1b</span><span class="s">[0m"</span> <span class="o">%</span> <span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">join_with_script_dir</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">__file__</span><span class="p">)),</span> <span class="n">path</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">ThreadingHTTPServer</span><span class="p">(</span><span class="n">ThreadingMixIn</span><span class="p">,</span> <span class="n">HTTPServer</span><span class="p">):</span>
    <span class="n">address_family</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">AF_INET6</span>
    <span class="n">daemon_threads</span> <span class="o">=</span> <span class="bp">True</span>

    <span class="k">def</span> <span class="nf">handle_error</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">client_address</span><span class="p">):</span>
        <span class="c"># surpress socket/ssl related errors</span>
        <span class="n">cls</span><span class="p">,</span> <span class="n">e</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()[:</span><span class="mi">2</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">cls</span> <span class="ow">is</span> <span class="n">socket</span><span class="o">.</span><span class="n">error</span> <span class="ow">or</span> <span class="n">cls</span> <span class="ow">is</span> <span class="n">ssl</span><span class="o">.</span><span class="n">SSLError</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">HTTPServer</span><span class="o">.</span><span class="n">handle_error</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">client_address</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">ProxyRequestHandler</span><span class="p">(</span><span class="n">BaseHTTPRequestHandler</span><span class="p">):</span>
    <span class="n">cakey</span> <span class="o">=</span> <span class="n">join_with_script_dir</span><span class="p">(</span><span class="s">'ca.key'</span><span class="p">)</span>
    <span class="n">cacert</span> <span class="o">=</span> <span class="n">join_with_script_dir</span><span class="p">(</span><span class="s">'ca.crt'</span><span class="p">)</span>
    <span class="n">certkey</span> <span class="o">=</span> <span class="n">join_with_script_dir</span><span class="p">(</span><span class="s">'cert.key'</span><span class="p">)</span>
    <span class="n">certdir</span> <span class="o">=</span> <span class="n">join_with_script_dir</span><span class="p">(</span><span class="s">'certs/'</span><span class="p">)</span>
    <span class="n">timeout</span> <span class="o">=</span> <span class="mi">5</span>
    <span class="n">lock</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Lock</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tls</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">local</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tls</span><span class="o">.</span><span class="n">conns</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="n">BaseHTTPRequestHandler</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">log_error</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">format</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="c"># surpress "Request timed out: timeout('timed out',)"</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">socket</span><span class="o">.</span><span class="n">timeout</span><span class="p">):</span>
            <span class="k">return</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">log_message</span><span class="p">(</span><span class="n">format</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">do_CONNECT</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cakey</span><span class="p">)</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cacert</span><span class="p">)</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">certkey</span><span class="p">)</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">certdir</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">connect_intercept</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">connect_relay</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">connect_intercept</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">hostname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">':'</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">certpath</span> <span class="o">=</span> <span class="s">"</span><span class="si">%</span><span class="s">s/</span><span class="si">%</span><span class="s">s.crt"</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">certdir</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s">'/'</span><span class="p">),</span> <span class="n">hostname</span><span class="p">)</span>

        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">lock</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">certpath</span><span class="p">):</span>
                <span class="n">epoch</span> <span class="o">=</span> <span class="s">"</span><span class="si">%</span><span class="s">d"</span> <span class="o">%</span> <span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">)</span>
                <span class="n">p1</span> <span class="o">=</span> <span class="n">Popen</span><span class="p">([</span><span class="s">"openssl"</span><span class="p">,</span> <span class="s">"req"</span><span class="p">,</span> <span class="s">"-new"</span><span class="p">,</span> <span class="s">"-key"</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">certkey</span><span class="p">,</span> <span class="s">"-subj"</span><span class="p">,</span> <span class="s">"/CN=</span><span class="si">%</span><span class="s">s"</span> <span class="o">%</span> <span class="n">hostname</span><span class="p">],</span> <span class="n">stdout</span><span class="o">=</span><span class="n">PIPE</span><span class="p">)</span>
                <span class="n">p2</span> <span class="o">=</span> <span class="n">Popen</span><span class="p">([</span><span class="s">"openssl"</span><span class="p">,</span> <span class="s">"x509"</span><span class="p">,</span> <span class="s">"-req"</span><span class="p">,</span> <span class="s">"-days"</span><span class="p">,</span> <span class="s">"3650"</span><span class="p">,</span> <span class="s">"-CA"</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cacert</span><span class="p">,</span> <span class="s">"-CAkey"</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cakey</span><span class="p">,</span> <span class="s">"-set_serial"</span><span class="p">,</span> <span class="n">epoch</span><span class="p">,</span> <span class="s">"-out"</span><span class="p">,</span> <span class="n">certpath</span><span class="p">],</span> <span class="n">stdin</span><span class="o">=</span><span class="n">p1</span><span class="o">.</span><span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="n">PIPE</span><span class="p">)</span>
                <span class="n">p2</span><span class="o">.</span><span class="n">communicate</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">wfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">"</span><span class="si">%</span><span class="s">s </span><span class="si">%</span><span class="s">d </span><span class="si">%</span><span class="s">s</span><span class="se">\r\n</span><span class="s">"</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">protocol_version</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="s">'Connection Established'</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">end_headers</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">connection</span> <span class="o">=</span> <span class="n">ssl</span><span class="o">.</span><span class="n">wrap_socket</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="p">,</span> <span class="n">keyfile</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">certkey</span><span class="p">,</span> <span class="n">certfile</span><span class="o">=</span><span class="n">certpath</span><span class="p">,</span> <span class="n">server_side</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rfile</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">makefile</span><span class="p">(</span><span class="s">"rb"</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rbufsize</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wfile</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">makefile</span><span class="p">(</span><span class="s">"wb"</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">wbufsize</span><span class="p">)</span>

        <span class="n">conntype</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">'Proxy-Connection'</span><span class="p">,</span> <span class="s">''</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">protocol_version</span> <span class="o">==</span> <span class="s">"HTTP/1.1"</span> <span class="ow">and</span> <span class="n">conntype</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">!=</span> <span class="s">'close'</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">close_connection</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">close_connection</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="k">def</span> <span class="nf">connect_relay</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">address</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">':'</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">address</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">address</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="ow">or</span> <span class="mi">443</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">create_connection</span><span class="p">(</span><span class="n">address</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">timeout</span><span class="p">)</span>
        <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">send_error</span><span class="p">(</span><span class="mi">502</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">send_response</span><span class="p">(</span><span class="mi">200</span><span class="p">,</span> <span class="s">'Connection Established'</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">end_headers</span><span class="p">()</span>

        <span class="n">conns</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="p">,</span> <span class="n">s</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">close_connection</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">close_connection</span><span class="p">:</span>
            <span class="n">rlist</span><span class="p">,</span> <span class="n">wlist</span><span class="p">,</span> <span class="n">xlist</span> <span class="o">=</span> <span class="n">select</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">conns</span><span class="p">,</span> <span class="p">[],</span> <span class="n">conns</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">timeout</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">xlist</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">rlist</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">rlist</span><span class="p">:</span>
                <span class="n">other</span> <span class="o">=</span> <span class="n">conns</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="n">r</span> <span class="ow">is</span> <span class="n">conns</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">else</span> <span class="n">conns</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">8192</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">data</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">close_connection</span> <span class="o">=</span> <span class="mi">1</span>
                    <span class="k">break</span>
                <span class="n">other</span><span class="o">.</span><span class="n">sendall</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">do_GET</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span> <span class="o">==</span> <span class="s">'http://proxy2.test/'</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">send_cacert</span><span class="p">()</span>
            <span class="k">return</span>

        <span class="n">req</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="n">content_length</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">req</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">'Content-Length'</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
        <span class="n">req_body</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rfile</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">content_length</span><span class="p">)</span> <span class="k">if</span> <span class="n">content_length</span> <span class="k">else</span> <span class="bp">None</span>

        <span class="k">if</span> <span class="n">req</span><span class="o">.</span><span class="n">path</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s">'/'</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="p">,</span> <span class="n">ssl</span><span class="o">.</span><span class="n">SSLSocket</span><span class="p">):</span>
                <span class="n">req</span><span class="o">.</span><span class="n">path</span> <span class="o">=</span> <span class="s">"https://</span><span class="si">%</span><span class="s">s</span><span class="si">%</span><span class="s">s"</span> <span class="o">%</span> <span class="p">(</span><span class="n">req</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s">'Host'</span><span class="p">],</span> <span class="n">req</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">req</span><span class="o">.</span><span class="n">path</span> <span class="o">=</span> <span class="s">"http://</span><span class="si">%</span><span class="s">s</span><span class="si">%</span><span class="s">s"</span> <span class="o">%</span> <span class="p">(</span><span class="n">req</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s">'Host'</span><span class="p">],</span> <span class="n">req</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>

        <span class="n">req_body_modified</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request_handler</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">req_body</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">req_body_modified</span> <span class="ow">is</span> <span class="bp">False</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">send_error</span><span class="p">(</span><span class="mi">403</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="k">elif</span> <span class="n">req_body_modified</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">req_body</span> <span class="o">=</span> <span class="n">req_body_modified</span>
            <span class="n">req</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s">'Content-length'</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">req_body</span><span class="p">))</span>

        <span class="n">u</span> <span class="o">=</span> <span class="n">urlparse</span><span class="o">.</span><span class="n">urlsplit</span><span class="p">(</span><span class="n">req</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>
        <span class="n">scheme</span><span class="p">,</span> <span class="n">netloc</span><span class="p">,</span> <span class="n">path</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">scheme</span><span class="p">,</span> <span class="n">u</span><span class="o">.</span><span class="n">netloc</span><span class="p">,</span> <span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">path</span> <span class="o">+</span> <span class="s">'?'</span> <span class="o">+</span> <span class="n">u</span><span class="o">.</span><span class="n">query</span> <span class="k">if</span> <span class="n">u</span><span class="o">.</span><span class="n">query</span> <span class="k">else</span> <span class="n">u</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">scheme</span> <span class="ow">in</span> <span class="p">(</span><span class="s">'http'</span><span class="p">,</span> <span class="s">'https'</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">netloc</span><span class="p">:</span>
            <span class="n">req</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s">'Host'</span><span class="p">]</span> <span class="o">=</span> <span class="n">netloc</span>
        <span class="nb">setattr</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="s">'headers'</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">filter_headers</span><span class="p">(</span><span class="n">req</span><span class="o">.</span><span class="n">headers</span><span class="p">))</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">origin</span> <span class="o">=</span> <span class="p">(</span><span class="n">scheme</span><span class="p">,</span> <span class="n">netloc</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">origin</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tls</span><span class="o">.</span><span class="n">conns</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">scheme</span> <span class="o">==</span> <span class="s">'https'</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">tls</span><span class="o">.</span><span class="n">conns</span><span class="p">[</span><span class="n">origin</span><span class="p">]</span> <span class="o">=</span> <span class="n">httplib</span><span class="o">.</span><span class="n">HTTPSConnection</span><span class="p">(</span><span class="n">netloc</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">timeout</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">tls</span><span class="o">.</span><span class="n">conns</span><span class="p">[</span><span class="n">origin</span><span class="p">]</span> <span class="o">=</span> <span class="n">httplib</span><span class="o">.</span><span class="n">HTTPConnection</span><span class="p">(</span><span class="n">netloc</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">timeout</span><span class="p">)</span>
            <span class="n">conn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tls</span><span class="o">.</span><span class="n">conns</span><span class="p">[</span><span class="n">origin</span><span class="p">]</span>
            <span class="n">conn</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">command</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">req_body</span><span class="p">,</span> <span class="nb">dict</span><span class="p">(</span><span class="n">req</span><span class="o">.</span><span class="n">headers</span><span class="p">))</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">getresponse</span><span class="p">()</span>

            <span class="n">version_table</span> <span class="o">=</span> <span class="p">{</span><span class="mi">10</span><span class="p">:</span> <span class="s">'HTTP/1.0'</span><span class="p">,</span> <span class="mi">11</span><span class="p">:</span> <span class="s">'HTTP/1.1'</span><span class="p">}</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="s">'headers'</span><span class="p">,</span> <span class="n">res</span><span class="o">.</span><span class="n">msg</span><span class="p">)</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="s">'response_version'</span><span class="p">,</span> <span class="n">version_table</span><span class="p">[</span><span class="n">res</span><span class="o">.</span><span class="n">version</span><span class="p">])</span>

            <span class="c"># support streaming</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="s">'Content-Length'</span> <span class="ow">in</span> <span class="n">res</span><span class="o">.</span><span class="n">headers</span> <span class="ow">and</span> <span class="s">'no-store'</span> <span class="ow">in</span> <span class="n">res</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">'Cache-Control'</span><span class="p">,</span> <span class="s">''</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">response_handler</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">req_body</span><span class="p">,</span> <span class="n">res</span><span class="p">,</span> <span class="s">''</span><span class="p">)</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="s">'headers'</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">filter_headers</span><span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">headers</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">relay_streaming</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>
                <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">lock</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">save_handler</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">req_body</span><span class="p">,</span> <span class="n">res</span><span class="p">,</span> <span class="s">''</span><span class="p">)</span>
                <span class="k">return</span>

            <span class="n">res_body</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">origin</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tls</span><span class="o">.</span><span class="n">conns</span><span class="p">:</span>
                <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">tls</span><span class="o">.</span><span class="n">conns</span><span class="p">[</span><span class="n">origin</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">send_error</span><span class="p">(</span><span class="mi">502</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="n">content_encoding</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">'Content-Encoding'</span><span class="p">,</span> <span class="s">'identity'</span><span class="p">)</span>
        <span class="n">res_body_plain</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">decode_content_body</span><span class="p">(</span><span class="n">res_body</span><span class="p">,</span> <span class="n">content_encoding</span><span class="p">)</span>

        <span class="n">res_body_modified</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">response_handler</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">req_body</span><span class="p">,</span> <span class="n">res</span><span class="p">,</span> <span class="n">res_body_plain</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">res_body_modified</span> <span class="ow">is</span> <span class="bp">False</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">send_error</span><span class="p">(</span><span class="mi">403</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="k">elif</span> <span class="n">res_body_modified</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">res_body_plain</span> <span class="o">=</span> <span class="n">res_body_modified</span>
            <span class="n">res_body</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">encode_content_body</span><span class="p">(</span><span class="n">res_body_plain</span><span class="p">,</span> <span class="n">content_encoding</span><span class="p">)</span>
            <span class="n">res</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s">'Content-Length'</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">res_body</span><span class="p">))</span>

        <span class="nb">setattr</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="s">'headers'</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">filter_headers</span><span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">headers</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">wfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">"</span><span class="si">%</span><span class="s">s </span><span class="si">%</span><span class="s">d </span><span class="si">%</span><span class="s">s</span><span class="se">\r\n</span><span class="s">"</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">protocol_version</span><span class="p">,</span> <span class="n">res</span><span class="o">.</span><span class="n">status</span><span class="p">,</span> <span class="n">res</span><span class="o">.</span><span class="n">reason</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">res</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">headers</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">wfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">end_headers</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">res_body</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wfile</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>

        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">lock</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">save_handler</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">req_body</span><span class="p">,</span> <span class="n">res</span><span class="p">,</span> <span class="n">res_body_plain</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">relay_streaming</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">res</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">"</span><span class="si">%</span><span class="s">s </span><span class="si">%</span><span class="s">d </span><span class="si">%</span><span class="s">s</span><span class="se">\r\n</span><span class="s">"</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">protocol_version</span><span class="p">,</span> <span class="n">res</span><span class="o">.</span><span class="n">status</span><span class="p">,</span> <span class="n">res</span><span class="o">.</span><span class="n">reason</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">res</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">headers</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">wfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">end_headers</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
                <span class="n">chunk</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">8192</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">chunk</span><span class="p">:</span>
                    <span class="k">break</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">wfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">chunk</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">wfile</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="k">except</span> <span class="n">socket</span><span class="o">.</span><span class="n">error</span><span class="p">:</span>
            <span class="c"># connection closed by client</span>
            <span class="k">pass</span>

    <span class="n">do_HEAD</span> <span class="o">=</span> <span class="n">do_GET</span>
    <span class="n">do_POST</span> <span class="o">=</span> <span class="n">do_GET</span>
    <span class="n">do_PUT</span> <span class="o">=</span> <span class="n">do_GET</span>
    <span class="n">do_DELETE</span> <span class="o">=</span> <span class="n">do_GET</span>
    <span class="n">do_OPTIONS</span> <span class="o">=</span> <span class="n">do_GET</span>

    <span class="k">def</span> <span class="nf">filter_headers</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">headers</span><span class="p">):</span>
        <span class="c"># http://tools.ietf.org/html/rfc2616#section-13.5.1</span>
        <span class="n">hop_by_hop</span> <span class="o">=</span> <span class="p">(</span><span class="s">'connection'</span><span class="p">,</span> <span class="s">'keep-alive'</span><span class="p">,</span> <span class="s">'proxy-authenticate'</span><span class="p">,</span> <span class="s">'proxy-authorization'</span><span class="p">,</span> <span class="s">'te'</span><span class="p">,</span> <span class="s">'trailers'</span><span class="p">,</span> <span class="s">'transfer-encoding'</span><span class="p">,</span> <span class="s">'upgrade'</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">hop_by_hop</span><span class="p">:</span>
            <span class="k">del</span> <span class="n">headers</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>

        <span class="c"># accept only supported encodings</span>
        <span class="k">if</span> <span class="s">'Accept-Encoding'</span> <span class="ow">in</span> <span class="n">headers</span><span class="p">:</span>
            <span class="n">ae</span> <span class="o">=</span> <span class="n">headers</span><span class="p">[</span><span class="s">'Accept-Encoding'</span><span class="p">]</span>
            <span class="n">filtered_encodings</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">re</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">r',\s*'</span><span class="p">,</span> <span class="n">ae</span><span class="p">)</span> <span class="k">if</span> <span class="n">x</span> <span class="ow">in</span> <span class="p">(</span><span class="s">'identity'</span><span class="p">,</span> <span class="s">'gzip'</span><span class="p">,</span> <span class="s">'x-gzip'</span><span class="p">,</span> <span class="s">'deflate'</span><span class="p">)]</span>
            <span class="n">headers</span><span class="p">[</span><span class="s">'Accept-Encoding'</span><span class="p">]</span> <span class="o">=</span> <span class="s">', '</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">filtered_encodings</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">headers</span>

    <span class="k">def</span> <span class="nf">encode_content_body</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="p">,</span> <span class="n">encoding</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">encoding</span> <span class="o">==</span> <span class="s">'identity'</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">text</span>
        <span class="k">elif</span> <span class="n">encoding</span> <span class="ow">in</span> <span class="p">(</span><span class="s">'gzip'</span><span class="p">,</span> <span class="s">'x-gzip'</span><span class="p">):</span>
            <span class="n">io</span> <span class="o">=</span> <span class="n">StringIO</span><span class="p">()</span>
            <span class="k">with</span> <span class="n">gzip</span><span class="o">.</span><span class="n">GzipFile</span><span class="p">(</span><span class="n">fileobj</span><span class="o">=</span><span class="n">io</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s">'wb'</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">getvalue</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">encoding</span> <span class="o">==</span> <span class="s">'deflate'</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">zlib</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nb">Exception</span><span class="p">(</span><span class="s">"Unknown Content-Encoding: </span><span class="si">%</span><span class="s">s"</span> <span class="o">%</span> <span class="n">encoding</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">data</span>

    <span class="k">def</span> <span class="nf">decode_content_body</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">encoding</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">encoding</span> <span class="o">==</span> <span class="s">'identity'</span><span class="p">:</span>
            <span class="n">text</span> <span class="o">=</span> <span class="n">data</span>
        <span class="k">elif</span> <span class="n">encoding</span> <span class="ow">in</span> <span class="p">(</span><span class="s">'gzip'</span><span class="p">,</span> <span class="s">'x-gzip'</span><span class="p">):</span>
            <span class="n">io</span> <span class="o">=</span> <span class="n">StringIO</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
            <span class="k">with</span> <span class="n">gzip</span><span class="o">.</span><span class="n">GzipFile</span><span class="p">(</span><span class="n">fileobj</span><span class="o">=</span><span class="n">io</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">text</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">encoding</span> <span class="o">==</span> <span class="s">'deflate'</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">text</span> <span class="o">=</span> <span class="n">zlib</span><span class="o">.</span><span class="n">decompress</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">zlib</span><span class="o">.</span><span class="n">error</span><span class="p">:</span>
                <span class="n">text</span> <span class="o">=</span> <span class="n">zlib</span><span class="o">.</span><span class="n">decompress</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="o">-</span><span class="n">zlib</span><span class="o">.</span><span class="n">MAX_WBITS</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nb">Exception</span><span class="p">(</span><span class="s">"Unknown Content-Encoding: </span><span class="si">%</span><span class="s">s"</span> <span class="o">%</span> <span class="n">encoding</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">text</span>

    <span class="k">def</span> <span class="nf">send_cacert</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cacert</span><span class="p">,</span> <span class="s">'rb'</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">wfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">"</span><span class="si">%</span><span class="s">s </span><span class="si">%</span><span class="s">d </span><span class="si">%</span><span class="s">s</span><span class="se">\r\n</span><span class="s">"</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">protocol_version</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="s">'OK'</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">send_header</span><span class="p">(</span><span class="s">'Content-Type'</span><span class="p">,</span> <span class="s">'application/x-x509-ca-cert'</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">send_header</span><span class="p">(</span><span class="s">'Content-Length'</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">send_header</span><span class="p">(</span><span class="s">'Connection'</span><span class="p">,</span> <span class="s">'close'</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">end_headers</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">print_info</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="n">req_body</span><span class="p">,</span> <span class="n">res</span><span class="p">,</span> <span class="n">res_body</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">parse_qsl</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
            <span class="k">return</span> <span class="s">'</span><span class="se">\n</span><span class="s">'</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s">"</span><span class="si">%-20</span><span class="s">s </span><span class="si">%</span><span class="s">s"</span> <span class="o">%</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">urlparse</span><span class="o">.</span><span class="n">parse_qsl</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">keep_blank_values</span><span class="o">=</span><span class="bp">True</span><span class="p">))</span>

        <span class="n">req_header_text</span> <span class="o">=</span> <span class="s">"</span><span class="si">%</span><span class="s">s </span><span class="si">%</span><span class="s">s </span><span class="si">%</span><span class="s">s</span><span class="se">\n</span><span class="si">%</span><span class="s">s"</span> <span class="o">%</span> <span class="p">(</span><span class="n">req</span><span class="o">.</span><span class="n">command</span><span class="p">,</span> <span class="n">req</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="n">req</span><span class="o">.</span><span class="n">request_version</span><span class="p">,</span> <span class="n">req</span><span class="o">.</span><span class="n">headers</span><span class="p">)</span>
        <span class="n">res_header_text</span> <span class="o">=</span> <span class="s">"</span><span class="si">%</span><span class="s">s </span><span class="si">%</span><span class="s">d </span><span class="si">%</span><span class="s">s</span><span class="se">\n</span><span class="si">%</span><span class="s">s"</span> <span class="o">%</span> <span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">response_version</span><span class="p">,</span> <span class="n">res</span><span class="o">.</span><span class="n">status</span><span class="p">,</span> <span class="n">res</span><span class="o">.</span><span class="n">reason</span><span class="p">,</span> <span class="n">res</span><span class="o">.</span><span class="n">headers</span><span class="p">)</span>

        <span class="k">print</span> <span class="n">with_color</span><span class="p">(</span><span class="mi">33</span><span class="p">,</span> <span class="n">req_header_text</span><span class="p">)</span>

        <span class="n">u</span> <span class="o">=</span> <span class="n">urlparse</span><span class="o">.</span><span class="n">urlsplit</span><span class="p">(</span><span class="n">req</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">u</span><span class="o">.</span><span class="n">query</span><span class="p">:</span>
            <span class="n">query_text</span> <span class="o">=</span> <span class="n">parse_qsl</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">query</span><span class="p">)</span>
            <span class="k">print</span> <span class="n">with_color</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="s">"==== QUERY PARAMETERS ====</span><span class="se">\n</span><span class="si">%</span><span class="s">s</span><span class="se">\n</span><span class="s">"</span> <span class="o">%</span> <span class="n">query_text</span><span class="p">)</span>

        <span class="n">cookie</span> <span class="o">=</span> <span class="n">req</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">'Cookie'</span><span class="p">,</span> <span class="s">''</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">cookie</span><span class="p">:</span>
            <span class="n">cookie</span> <span class="o">=</span> <span class="n">parse_qsl</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s">r';\s*'</span><span class="p">,</span> <span class="s">'&amp;'</span><span class="p">,</span> <span class="n">cookie</span><span class="p">))</span>
            <span class="k">print</span> <span class="n">with_color</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="s">"==== COOKIE ====</span><span class="se">\n</span><span class="si">%</span><span class="s">s</span><span class="se">\n</span><span class="s">"</span> <span class="o">%</span> <span class="n">cookie</span><span class="p">)</span>

        <span class="n">auth</span> <span class="o">=</span> <span class="n">req</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">'Authorization'</span><span class="p">,</span> <span class="s">''</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">auth</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">'basic'</span><span class="p">):</span>
            <span class="n">token</span> <span class="o">=</span> <span class="n">auth</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s">'base64'</span><span class="p">)</span>
            <span class="k">print</span> <span class="n">with_color</span><span class="p">(</span><span class="mi">31</span><span class="p">,</span> <span class="s">"==== BASIC AUTH ====</span><span class="se">\n</span><span class="si">%</span><span class="s">s</span><span class="se">\n</span><span class="s">"</span> <span class="o">%</span> <span class="n">token</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">req_body</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">req_body_text</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="n">content_type</span> <span class="o">=</span> <span class="n">req</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">'Content-Type'</span><span class="p">,</span> <span class="s">''</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">content_type</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">'application/x-www-form-urlencoded'</span><span class="p">):</span>
                <span class="n">req_body_text</span> <span class="o">=</span> <span class="n">parse_qsl</span><span class="p">(</span><span class="n">req_body</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">content_type</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">'application/json'</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">json_obj</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">req_body</span><span class="p">)</span>
                    <span class="n">json_str</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">json_obj</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">json_str</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s">'</span><span class="se">\n</span><span class="s">'</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">50</span><span class="p">:</span>
                        <span class="n">req_body_text</span> <span class="o">=</span> <span class="n">json_str</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">lines</span> <span class="o">=</span> <span class="n">json_str</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()</span>
                        <span class="n">req_body_text</span> <span class="o">=</span> <span class="s">"</span><span class="si">%</span><span class="s">s</span><span class="se">\n</span><span class="s">(</span><span class="si">%</span><span class="s">d lines)"</span> <span class="o">%</span> <span class="p">(</span><span class="s">'</span><span class="se">\n</span><span class="s">'</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">[:</span><span class="mi">50</span><span class="p">]),</span> <span class="nb">len</span><span class="p">(</span><span class="n">lines</span><span class="p">))</span>
                <span class="k">except</span> <span class="nb">ValueError</span><span class="p">:</span>
                    <span class="n">req_body_text</span> <span class="o">=</span> <span class="n">req_body</span>
            <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">req_body</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">1024</span><span class="p">:</span>
                <span class="n">req_body_text</span> <span class="o">=</span> <span class="n">req_body</span>

            <span class="k">if</span> <span class="n">req_body_text</span><span class="p">:</span>
                <span class="k">print</span> <span class="n">with_color</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="s">"==== REQUEST BODY ====</span><span class="se">\n</span><span class="si">%</span><span class="s">s</span><span class="se">\n</span><span class="s">"</span> <span class="o">%</span> <span class="n">req_body_text</span><span class="p">)</span>

        <span class="k">print</span> <span class="n">with_color</span><span class="p">(</span><span class="mi">36</span><span class="p">,</span> <span class="n">res_header_text</span><span class="p">)</span>

        <span class="n">cookies</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">getheaders</span><span class="p">(</span><span class="s">'Set-Cookie'</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">cookies</span><span class="p">:</span>
            <span class="n">cookies</span> <span class="o">=</span> <span class="s">'</span><span class="se">\n</span><span class="s">'</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cookies</span><span class="p">)</span>
            <span class="k">print</span> <span class="n">with_color</span><span class="p">(</span><span class="mi">31</span><span class="p">,</span> <span class="s">"==== SET-COOKIE ====</span><span class="se">\n</span><span class="si">%</span><span class="s">s</span><span class="se">\n</span><span class="s">"</span> <span class="o">%</span> <span class="n">cookies</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">res_body</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">res_body_text</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="n">content_type</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">'Content-Type'</span><span class="p">,</span> <span class="s">''</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">content_type</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">'application/json'</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">json_obj</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">res_body</span><span class="p">)</span>
                    <span class="n">json_str</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">json_obj</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">json_str</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s">'</span><span class="se">\n</span><span class="s">'</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">50</span><span class="p">:</span>
                        <span class="n">res_body_text</span> <span class="o">=</span> <span class="n">json_str</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">lines</span> <span class="o">=</span> <span class="n">json_str</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()</span>
                        <span class="n">res_body_text</span> <span class="o">=</span> <span class="s">"</span><span class="si">%</span><span class="s">s</span><span class="se">\n</span><span class="s">(</span><span class="si">%</span><span class="s">d lines)"</span> <span class="o">%</span> <span class="p">(</span><span class="s">'</span><span class="se">\n</span><span class="s">'</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">[:</span><span class="mi">50</span><span class="p">]),</span> <span class="nb">len</span><span class="p">(</span><span class="n">lines</span><span class="p">))</span>
                <span class="k">except</span> <span class="nb">ValueError</span><span class="p">:</span>
                    <span class="n">res_body_text</span> <span class="o">=</span> <span class="n">res_body</span>
            <span class="k">elif</span> <span class="n">content_type</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">'text/html'</span><span class="p">):</span>
                <span class="n">m</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s">r'&lt;title[^&gt;]*&gt;\s*([^&lt;]+?)\s*&lt;/title&gt;'</span><span class="p">,</span> <span class="n">res_body</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">I</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">m</span><span class="p">:</span>
                    <span class="n">h</span> <span class="o">=</span> <span class="n">HTMLParser</span><span class="p">()</span>
                    <span class="k">print</span> <span class="n">with_color</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="s">"==== HTML TITLE ====</span><span class="se">\n</span><span class="si">%</span><span class="s">s</span><span class="se">\n</span><span class="s">"</span> <span class="o">%</span> <span class="n">h</span><span class="o">.</span><span class="n">unescape</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s">'utf-8'</span><span class="p">)))</span>
            <span class="k">elif</span> <span class="n">content_type</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">'text/'</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">res_body</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">1024</span><span class="p">:</span>
                <span class="n">res_body_text</span> <span class="o">=</span> <span class="n">res_body</span>

            <span class="k">if</span> <span class="n">res_body_text</span><span class="p">:</span>
                <span class="k">print</span> <span class="n">with_color</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="s">"==== RESPONSE BODY ====</span><span class="se">\n</span><span class="si">%</span><span class="s">s</span><span class="se">\n</span><span class="s">"</span> <span class="o">%</span> <span class="n">res_body_text</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">request_handler</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="n">req_body</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">response_handler</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="n">req_body</span><span class="p">,</span> <span class="n">res</span><span class="p">,</span> <span class="n">res_body</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">save_handler</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="n">req_body</span><span class="p">,</span> <span class="n">res</span><span class="p">,</span> <span class="n">res_body</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">print_info</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">req_body</span><span class="p">,</span> <span class="n">res</span><span class="p">,</span> <span class="n">res_body</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">test</span><span class="p">(</span><span class="n">HandlerClass</span><span class="o">=</span><span class="n">ProxyRequestHandler</span><span class="p">,</span> <span class="n">ServerClass</span><span class="o">=</span><span class="n">ThreadingHTTPServer</span><span class="p">,</span> <span class="n">protocol</span><span class="o">=</span><span class="s">"HTTP/1.1"</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
        <span class="n">port</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">port</span> <span class="o">=</span> <span class="mi">8080</span>
    <span class="n">server_address</span> <span class="o">=</span> <span class="p">(</span><span class="s">'::1'</span><span class="p">,</span> <span class="n">port</span><span class="p">)</span>

    <span class="n">HandlerClass</span><span class="o">.</span><span class="n">protocol_version</span> <span class="o">=</span> <span class="n">protocol</span>
    <span class="n">httpd</span> <span class="o">=</span> <span class="n">ServerClass</span><span class="p">(</span><span class="n">server_address</span><span class="p">,</span> <span class="n">HandlerClass</span><span class="p">)</span>

    <span class="n">sa</span> <span class="o">=</span> <span class="n">httpd</span><span class="o">.</span><span class="n">socket</span><span class="o">.</span><span class="n">getsockname</span><span class="p">()</span>
    <span class="k">print</span> <span class="s">"Serving HTTP Proxy on"</span><span class="p">,</span> <span class="n">sa</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s">"port"</span><span class="p">,</span> <span class="n">sa</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s">"..."</span>
    <span class="n">httpd</span><span class="o">.</span><span class="n">serve_forever</span><span class="p">()</span>


<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">'__main__'</span><span class="p">:</span>
    <span class="n">test</span><span class="p">()</span>
</code></pre><pre class="highlight java tab-java"><code><span class="n">Please</span> <span class="n">contact</span> <span class="n">our</span> <span class="n">support</span> <span class="n">team</span> <span class="n">at</span> <span class="s">"support@adback.co"</span> <span class="n">to</span> <span class="n">configure</span> <span class="n">adback</span> <span class="n">with</span> <span class="n">Java</span>
</code></pre><pre class="highlight ruby tab-ruby"><code><span class="sr">//</span><span class="n">proxy</span><span class="p">.</span><span class="nf">rb</span> <span class="no">Untested</span> <span class="o">!</span>
<span class="sr">//</span> <span class="no">Source</span><span class="p">:</span> <span class="n">https</span><span class="ss">:/</span><span class="o">/</span><span class="n">gist</span><span class="p">.</span><span class="nf">githubusercontent</span><span class="p">.</span><span class="nf">com</span><span class="o">/</span><span class="n">torsten</span><span class="o">/</span><span class="mi">74107</span><span class="o">/</span><span class="n">raw</span><span class="o">/</span><span class="n">f3c666d9b7bf4ba1a6bbd5f4335e010beaed13d3</span><span class="o">/</span><span class="n">proxy</span><span class="p">.</span><span class="nf">rb</span>
<span class="c1">#!/usr/bin/env ruby</span>
<span class="c1"># A quick and dirty implementation of an HTTP proxy server in Ruby</span>
<span class="c1"># because I did not want to install anything.</span>
<span class="c1"># </span>
<span class="c1"># Copyright (C) 2009-2014 Torsten Becker &lt;torsten.becker@gmail.com&gt;</span>
<span class="c1"># </span>
<span class="c1"># Permission is hereby granted, free of charge, to any person obtaining</span>
<span class="c1"># a copy of this software and associated documentation files (the</span>
<span class="c1"># "Software"), to deal in the Software without restriction, including</span>
<span class="c1"># without limitation the rights to use, copy, modify, merge, publish,</span>
<span class="c1"># distribute, sublicense, and/or sell copies of the Software, and to</span>
<span class="c1"># permit persons to whom the Software is furnished to do so, subject to</span>
<span class="c1"># the following conditions:</span>
<span class="c1"># </span>
<span class="c1"># The above copyright notice and this permission notice shall be</span>
<span class="c1"># included in all copies or substantial portions of the Software.</span>
<span class="c1"># </span>
<span class="c1"># THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,</span>
<span class="c1"># EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF</span>
<span class="c1"># MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND</span>
<span class="c1"># NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE</span>
<span class="c1"># LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION</span>
<span class="c1"># OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION</span>
<span class="c1"># WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.</span>

<span class="nb">require</span> <span class="s1">'socket'</span>
<span class="nb">require</span> <span class="s1">'uri'</span>


<span class="k">class</span> <span class="nc">Proxy</span>  
  <span class="k">def</span> <span class="nf">run</span> <span class="n">port</span>
    <span class="k">begin</span>
      <span class="c1"># Start our server to handle connections (will raise things on errors)</span>
      <span class="vi">@socket</span> <span class="o">=</span> <span class="no">TCPServer</span><span class="p">.</span><span class="nf">new</span> <span class="n">port</span>

      <span class="c1"># Handle every request in another thread</span>
      <span class="kp">loop</span> <span class="k">do</span>
        <span class="n">s</span> <span class="o">=</span> <span class="vi">@socket</span><span class="p">.</span><span class="nf">accept</span>
        <span class="no">Thread</span><span class="p">.</span><span class="nf">new</span> <span class="n">s</span><span class="p">,</span> <span class="o">&amp;</span><span class="nb">method</span><span class="p">(</span><span class="ss">:handle_request</span><span class="p">)</span>
      <span class="k">end</span>

    <span class="c1"># CTRL-C</span>
    <span class="k">rescue</span> <span class="no">Interrupt</span>
      <span class="nb">puts</span> <span class="s1">'Got Interrupt..'</span>
    <span class="c1"># Ensure that we release the socket on errors</span>
    <span class="k">ensure</span>
      <span class="k">if</span> <span class="vi">@socket</span>
        <span class="vi">@socket</span><span class="p">.</span><span class="nf">close</span>
        <span class="nb">puts</span> <span class="s1">'Socked closed..'</span>
      <span class="k">end</span>
      <span class="nb">puts</span> <span class="s1">'Quitting.'</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">handle_request</span> <span class="n">to_client</span>
    <span class="n">request_line</span> <span class="o">=</span> <span class="n">to_client</span><span class="p">.</span><span class="nf">readline</span>

    <span class="n">verb</span>    <span class="o">=</span> <span class="n">request_line</span><span class="p">[</span><span class="sr">/^\w+/</span><span class="p">]</span>
    <span class="n">url</span>     <span class="o">=</span> <span class="n">request_line</span><span class="p">[</span><span class="sr">/^\w+\s+(\S+)/</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
    <span class="n">version</span> <span class="o">=</span> <span class="n">request_line</span><span class="p">[</span><span class="sr">/HTTP\/(1\.\d)\s*$/</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
    <span class="n">uri</span>     <span class="o">=</span> <span class="no">URI</span><span class="o">::</span><span class="n">parse</span> <span class="n">url</span>

    <span class="c1"># Show what got requested</span>
    <span class="nb">puts</span><span class="p">((</span><span class="s2">" %4s "</span><span class="o">%</span><span class="n">verb</span><span class="p">)</span> <span class="o">+</span> <span class="n">url</span><span class="p">)</span>

    <span class="n">to_server</span> <span class="o">=</span> <span class="no">TCPSocket</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="n">uri</span><span class="p">.</span><span class="nf">host</span><span class="p">,</span> <span class="p">(</span><span class="n">uri</span><span class="p">.</span><span class="nf">port</span><span class="p">.</span><span class="nf">nil?</span> <span class="p">?</span> <span class="mi">80</span> <span class="p">:</span> <span class="n">uri</span><span class="p">.</span><span class="nf">port</span><span class="p">))</span>
    <span class="n">to_server</span><span class="p">.</span><span class="nf">write</span><span class="p">(</span><span class="s2">"</span><span class="si">#{</span><span class="n">verb</span><span class="si">}</span><span class="s2"> </span><span class="si">#{</span><span class="n">uri</span><span class="p">.</span><span class="nf">path</span><span class="si">}</span><span class="s2">?</span><span class="si">#{</span><span class="n">uri</span><span class="p">.</span><span class="nf">query</span><span class="si">}</span><span class="s2"> HTTP/</span><span class="si">#{</span><span class="n">version</span><span class="si">}</span><span class="se">\r\n</span><span class="s2">"</span><span class="p">)</span>

    <span class="n">content_len</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="kp">loop</span> <span class="k">do</span>      
      <span class="n">line</span> <span class="o">=</span> <span class="n">to_client</span><span class="p">.</span><span class="nf">readline</span>

      <span class="k">if</span> <span class="n">line</span> <span class="o">=~</span> <span class="sr">/^Content-Length:\s+(\d+)\s*$/</span>
        <span class="n">content_len</span> <span class="o">=</span> <span class="vg">$1</span><span class="p">.</span><span class="nf">to_i</span>
      <span class="k">end</span>

      <span class="c1"># Strip proxy headers</span>
      <span class="k">if</span> <span class="n">line</span> <span class="o">=~</span> <span class="sr">/^proxy/i</span>
        <span class="k">next</span>
      <span class="k">elsif</span> <span class="n">line</span><span class="p">.</span><span class="nf">strip</span><span class="p">.</span><span class="nf">empty?</span>
        <span class="n">to_server</span><span class="p">.</span><span class="nf">write</span><span class="p">(</span><span class="s2">"Connection: close</span><span class="se">\r\n\r\n</span><span class="s2">"</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">content_len</span> <span class="o">&gt;=</span> <span class="mi">0</span>
          <span class="n">to_server</span><span class="p">.</span><span class="nf">write</span><span class="p">(</span><span class="n">to_client</span><span class="p">.</span><span class="nf">read</span><span class="p">(</span><span class="n">content_len</span><span class="p">))</span>
        <span class="k">end</span>

        <span class="k">break</span>
      <span class="k">else</span>
        <span class="n">to_server</span><span class="p">.</span><span class="nf">write</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
      <span class="k">end</span>
    <span class="k">end</span>

    <span class="n">buff</span> <span class="o">=</span> <span class="s2">""</span>
    <span class="kp">loop</span> <span class="k">do</span>
      <span class="n">to_server</span><span class="p">.</span><span class="nf">read</span><span class="p">(</span><span class="mi">4048</span><span class="p">,</span> <span class="n">buff</span><span class="p">)</span>
      <span class="n">to_client</span><span class="p">.</span><span class="nf">write</span><span class="p">(</span><span class="n">buff</span><span class="p">)</span>
      <span class="k">break</span> <span class="k">if</span> <span class="n">buff</span><span class="p">.</span><span class="nf">size</span> <span class="o">&lt;</span> <span class="mi">4048</span>
    <span class="k">end</span>

    <span class="c1"># Close the sockets</span>
    <span class="n">to_client</span><span class="p">.</span><span class="nf">close</span>
    <span class="n">to_server</span><span class="p">.</span><span class="nf">close</span>
  <span class="k">end</span>

<span class="k">end</span>


<span class="c1"># Get parameters and start the server</span>
<span class="k">if</span> <span class="no">ARGV</span><span class="p">.</span><span class="nf">empty?</span>
  <span class="n">port</span> <span class="o">=</span> <span class="mi">8008</span>
<span class="k">elsif</span> <span class="no">ARGV</span><span class="p">.</span><span class="nf">size</span> <span class="o">==</span> <span class="mi">1</span>
  <span class="n">port</span> <span class="o">=</span> <span class="no">ARGV</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nf">to_i</span>
<span class="k">else</span>
  <span class="nb">puts</span> <span class="s1">'Usage: proxy.rb [port]'</span>
  <span class="nb">exit</span> <span class="mi">1</span>
<span class="k">end</span>

<span class="no">Proxy</span><span class="p">.</span><span class="nf">new</span><span class="p">.</span><span class="nf">run</span> <span class="n">port</span>
</code></pre><pre class="highlight shell tab-shell"><code>Please contact our support team at <span class="s2">"support@adback.co"</span> to configure adback with Shell
</code></pre><pre class="highlight twig tab-twig"><code>Your Symfony extension should handle proxy without any change from you
</code></pre>
<p>You could choose between two ways of configuring your endpoint: using your webserver or a programming language</p>

<p>These scripts are for example purpose only. </p>

<p>To help you create your own proxy file, please send us the following information at support@adback.co: </p>

<ul>
<li><p>Which webserver software are you using? (Apache, Nginx, ...) </p></li>
<li><p>Which programming language are you using? (PHP, Java, Python, ...) </p></li>
<li><p>Which cache technology are you using? (Redis, Memcached, MySQL database, ...) </p></li>
</ul>

<p>You can download configuration file from adback back-office for <a href="https://www.adback.co/fr/integration/endpoints/configuration/files">Apache2</a>, <a href="https://www.adback.co/fr/integration/endpoints/configuration/files">Nginx</a>, or <a href="https://www.adback.co/fr/integration/endpoints/configuration/files">Varnish</a> (Must be logged)</p>

<aside class="warning">If you are using an external CDN like cloudflare, make sure that you have disable the javascript minification.</aside>
<h3 id='code-logic-3'>Code logic:</h3>
<ul>
<li><p>Receive call from your users via the tag integrated on your pages</p></li>
<li><p>Transmit call to AdBack servers </p></li>
<li><p>Receive response from AdBack servers</p></li>
<li><p>Transmit response to your users</p></li>
</ul>
<h1 id='adback-api-3rd-party-analytics-only'>AdBack API (3rd Party Analytics only)</h1>
<p>If you want to test AdBack without using our first party (proxy) system, you could install our third party one.</p>

<p>It will provide the same features as the first party install, but be careful to the fact that this way can be blocked if Adblock starts blocking third party scripts on your website.</p>

<p>Please follow these steps to install AdBack using our API.</p>
<h2 id='1-get-script-names-and-url'>1) Get script names and URL</h2>
<blockquote>
<p>Sample script:</p>
</blockquote>
<pre class="highlight php tab-php"><code><span class="cp">&lt;?php</span>

<span class="cm">/* here we use redis to cache api requests */</span>
<span class="nv">$cache</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Redis</span><span class="p">();</span>
<span class="nv">$cache</span><span class="o">-&gt;</span><span class="na">connect</span><span class="p">(</span><span class="s1">'host'</span><span class="p">);</span>

<span class="nv">$scriptElements</span> <span class="o">=</span> <span class="nb">json_decode</span><span class="p">(</span><span class="nb">file_get_contents</span><span class="p">(</span><span class="s1">'https://adback.co/api/script/me?access_token=[token]'</span><span class="p">),</span> <span class="kc">true</span><span class="p">);</span>
<span class="sd">/** @var array $scriptElements */</span>
<span class="k">foreach</span> <span class="p">(</span><span class="nv">$scriptElements</span> <span class="k">as</span> <span class="nv">$key</span> <span class="o">=&gt;</span> <span class="nv">$value</span><span class="p">)</span> <span class="p">{</span>
    <span class="nv">$cache</span><span class="o">-&gt;</span><span class="na">hSet</span><span class="p">(</span><span class="s1">'scriptElement'</span><span class="p">,</span> <span class="nv">$key</span><span class="p">,</span> <span class="nv">$value</span><span class="p">);</span>
<span class="p">}</span>
<span class="nv">$cache</span><span class="o">-&gt;</span><span class="na">expire</span><span class="p">(</span><span class="s1">'scriptElement'</span><span class="p">,</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">6</span><span class="p">);</span>
</code></pre><pre class="highlight python tab-python"><code><span class="kn">import</span> <span class="nn">redis</span>
<span class="kn">import</span> <span class="nn">requests</span>

<span class="s">'''here we use redis to cache api requests'''</span>
<span class="n">r_server</span> <span class="o">=</span> <span class="n">redis</span><span class="o">.</span><span class="n">Redis</span><span class="p">(</span><span class="s">'host'</span><span class="p">,</span> <span class="s">'port'</span><span class="p">)</span>
<span class="n">script_elements</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">'https://adback.co/api/script/me?access_token=[token]'</span><span class="p">)</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
<span class="k">for</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span> <span class="ow">in</span> <span class="n">script_elements</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="n">r_server</span><span class="o">.</span><span class="n">hset</span><span class="p">(</span><span class="s">'script_element'</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s">"utf8"</span><span class="p">))</span>
<span class="n">r_server</span><span class="o">.</span><span class="n">expire</span><span class="p">(</span><span class="s">'script_element'</span><span class="p">,</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">6</span><span class="p">)</span>
</code></pre><pre class="highlight java tab-java"><code><span class="n">Please</span> <span class="n">contact</span> <span class="n">our</span> <span class="n">support</span> <span class="n">team</span> <span class="n">at</span> <span class="s">"support@adback.co"</span> <span class="n">to</span> <span class="n">configure</span> <span class="n">adback</span> <span class="n">with</span> <span class="n">Java</span>
</code></pre><pre class="highlight ruby tab-ruby"><code><span class="nb">require</span> <span class="s2">"redis"</span>
<span class="nb">require</span> <span class="s2">"json"</span>
<span class="nb">require</span> <span class="s1">'open-uri'</span>

<span class="c1"># here we use redis to cache api requests</span>
<span class="n">cache</span> <span class="o">=</span> <span class="no">Redis</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="ss">:host</span> <span class="o">=&gt;</span> <span class="s2">"HOST"</span><span class="p">)</span>
<span class="n">script</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s1">'https://adback.co/api/script/me?access_token=[token]'</span><span class="p">).</span><span class="nf">read</span>
<span class="n">script_elements</span> <span class="o">=</span> <span class="no">JSON</span><span class="p">.</span><span class="nf">parse</span><span class="p">(</span><span class="n">script</span><span class="p">)</span>
<span class="n">script_elements</span><span class="p">.</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="o">|</span>
  <span class="n">cache</span><span class="p">.</span><span class="nf">hset</span><span class="p">(</span><span class="s1">'script_element'</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
<span class="k">end</span>
<span class="n">cache</span><span class="p">.</span><span class="nf">expire</span><span class="p">(</span><span class="s1">'script_element'</span><span class="p">,</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">6</span><span class="p">)</span>
</code></pre><pre class="highlight shell tab-shell"><code><span class="c"># curl command</span>

curl -X <span class="s2">"GET"</span> <span class="s1">'https://adback.co/api/script/me?access_token="token"'</span>
</code></pre><pre class="highlight twig tab-twig"><code># Launch the Symfony command to refesh the tags

$ php app/console adback:api-client:refresh-tag
</code></pre>
<blockquote>
<p>The above API call returns JSON structured like this:</p>
</blockquote>
<pre class="highlight json tab-json"><code><span class="p">{</span><span class="w">
  </span><span class="s2">"analytics_domain"</span><span class="p">:</span><span class="w"> </span><span class="s2">"example.url.com"</span><span class="p">,</span><span class="w">
  </span><span class="s2">"analytics_script"</span><span class="p">:</span><span class="w"> </span><span class="s2">"scriptname"</span><span class="p">,</span><span class="w">
  </span><span class="s2">"message_domain"</span><span class="p">:</span><span class="w"> </span><span class="s2">"example.url.com"</span><span class="p">,</span><span class="w">
  </span><span class="s2">"message_script"</span><span class="p">:</span><span class="w"> </span><span class="s2">"scriptname"</span><span class="p">,</span><span class="w">
  </span><span class="s2">"product_domain"</span><span class="p">:</span><span class="w"> </span><span class="s2">"example.url.com"</span><span class="p">,</span><span class="w">
  </span><span class="s2">"product_script"</span><span class="p">:</span><span class="w"> </span><span class="s2">"scriptname"</span><span class="p">,</span><span class="w">
  </span><span class="s2">"iab_banner_domain"</span><span class="p">:</span><span class="w"> </span><span class="s2">"example.url.com"</span><span class="p">,</span><span class="w">
  </span><span class="s2">"iab_banner_script"</span><span class="p">:</span><span class="w"> </span><span class="s2">"scriptname"</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre>
<p>AdBack provides 4 different scripts that you can generate and display from your server.</p>

<p>Here is the first step to implement AdBack solution.</p>

<p>Call AdBack API to get script names and URL, store it in your preferred local cache provider.</p>
<h3 id='code-logic-4'>Code logic:</h3>
<ul>
<li><p>connect to your cache provider to limit api calls (here Redis)</p></li>
<li><p>call AdBack API to get tags information </p></li>
<li><p>cache all information</p></li>
<li><p>set cache expiry time to 6 hours</p></li>
</ul>
<h3 id='http-request-2'>HTTP Request:</h3>
<p><code>GET https://adback.co/api/script/me</code></p>
<h3 id='query-parameters-2'>Query Parameters:</h3>
<table><thead>
<tr>
<th>Parameter</th>
<th>Required</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td>access_token</td>
<td>Yes</td>
<td>Personal token for authentication, <a href="https://www.adback.co/en/admin/api/">here</a> you can get your token</td>
</tr>
</tbody></table>

<aside class="notice">
If API doesn't return all script names or URL, please check your configuration <a href="https://www.adback.co/en/integration/admin/activation">here</a> and make sure all tags are activated.
</aside>

<aside class="warning">You should setup cron task or service to refresh tag every 6 hours</aside>
<h2 id='2-analytics-script'>2) Analytics script</h2>
<blockquote>
<p>Sample script:</p>
</blockquote>
<pre class="highlight php tab-php"><code>
<span class="cp">&lt;?php</span>
<span class="cm">/* here we use redis to cache api requests */</span>
<span class="nv">$cache</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Redis</span><span class="p">();</span>
<span class="nv">$cache</span><span class="o">-&gt;</span><span class="na">connect</span><span class="p">(</span><span class="s1">'host'</span><span class="p">,</span> <span class="s1">'port'</span><span class="p">);</span>

<span class="nv">$analyticsScriptCode</span> <span class="o">=</span> <span class="s1">''</span><span class="p">;</span>
<span class="k">if</span> <span class="p">(</span><span class="nv">$cache</span><span class="o">-&gt;</span><span class="na">has</span><span class="p">(</span><span class="s1">'scriptElement'</span><span class="p">))</span> <span class="p">{</span>
    <span class="nv">$scriptElements</span> <span class="o">=</span> <span class="nv">$cache</span><span class="o">-&gt;</span><span class="na">hGetAll</span><span class="p">(</span><span class="s1">'scriptElement'</span><span class="p">);</span>
    <span class="nv">$analyticsDomain</span> <span class="o">=</span> <span class="nv">$scriptElements</span><span class="p">[</span><span class="s1">'analytics_domain'</span><span class="p">];</span>
    <span class="nv">$analyticsScript</span> <span class="o">=</span> <span class="nv">$scriptElements</span><span class="p">[</span><span class="s1">'analytics_script'</span><span class="p">];</span>

    <span class="nv">$analyticsScriptCode</span> <span class="o">=</span> <span class="sh">&lt;&lt;&lt;EOS
        (function (a,d){var s,t;s=d.createElement('script');
        s.src=a;s.async=1;
        t=d.getElementsByTagName('script')[0];
        t.parentNode.insertBefore(s,t);
        })("https://$analyticsDomain/$analyticsScript.js", document);
EOS;
</span><span class="p">}</span>

<span class="cm">/* display tag */</span>
<span class="k">echo</span> <span class="s2">"&lt;script&gt;</span><span class="nv">$analyticsScriptCode</span><span class="s2">&lt;/script&gt;"</span><span class="p">;</span>
</code></pre><pre class="highlight python tab-python"><code><span class="kn">import</span> <span class="nn">redis</span>
<span class="kn">import</span> <span class="nn">requests</span>

<span class="s">'''here we use redis to cache api requests'''</span>
<span class="n">r_server</span> <span class="o">=</span> <span class="n">redis</span><span class="o">.</span><span class="n">Redis</span><span class="p">(</span><span class="s">'host'</span><span class="p">,</span> <span class="s">'port'</span><span class="p">)</span>
<span class="n">analytics_script_code</span> <span class="o">=</span> <span class="s">''</span>
<span class="k">if</span> <span class="n">r_server</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="s">'script_element'</span><span class="p">):</span>
    <span class="n">script_elements</span> <span class="o">=</span> <span class="n">r_server</span><span class="o">.</span><span class="n">hgetall</span><span class="p">(</span><span class="s">'script_element'</span><span class="p">)</span>
    <span class="n">analytics_domain</span> <span class="o">=</span> <span class="n">script_elements</span><span class="p">[</span><span class="s">'analytics_domain'</span><span class="p">]</span>
    <span class="n">analytics_script</span> <span class="o">=</span> <span class="n">script_elements</span><span class="p">[</span><span class="s">'analytics_script'</span><span class="p">]</span>

    <span class="n">analytics_script_code</span> <span class="o">=</span> <span class="s">"""
    (function (a,d){var s,t;s=d.createElement('script');
    s.src=a;s.async=1;
    t=d.getElementsByTagName('script')[0];
    t.parentNode.insertBefore(s,t);
    })(</span><span class="se">\"</span><span class="s">https://</span><span class="si">%</span><span class="s">s/</span><span class="si">%</span><span class="s">s.js</span><span class="se">\"</span><span class="s">, document);
    """</span> <span class="o">%</span> <span class="p">(</span><span class="n">analytics_domain</span><span class="p">,</span> <span class="n">analytics_script</span><span class="p">)</span>

<span class="s">''' display tag '''</span>
<span class="k">print</span> <span class="s">"&lt;script&gt;</span><span class="si">%</span><span class="s">s&lt;/script&gt;"</span> <span class="o">%</span> <span class="n">analytics_script_code</span>
</code></pre><pre class="highlight java tab-java"><code><span class="n">Please</span> <span class="n">contact</span> <span class="n">our</span> <span class="n">support</span> <span class="n">team</span> <span class="n">at</span> <span class="s">"support@adback.co"</span> <span class="n">to</span> <span class="n">configure</span> <span class="n">adback</span> <span class="n">with</span> <span class="n">Java</span>
</code></pre><pre class="highlight ruby tab-ruby"><code><span class="nb">require</span> <span class="s2">"redis"</span>
<span class="nb">require</span> <span class="s2">"json"</span>
<span class="nb">require</span> <span class="s1">'open-uri'</span>

<span class="c1"># here we use redis to cache api requests</span>
<span class="n">cache</span> <span class="o">=</span> <span class="no">Redis</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="ss">:host</span> <span class="o">=&gt;</span> <span class="s2">"HOST"</span><span class="p">)</span>
<span class="n">analytics_script_code</span> <span class="o">=</span> <span class="s1">''</span><span class="p">;</span>
<span class="k">if</span> <span class="n">cache</span><span class="p">.</span><span class="nf">exists</span><span class="p">(</span><span class="s1">'script_element'</span><span class="p">)</span>
  <span class="n">script_elements</span> <span class="o">=</span> <span class="n">cache</span><span class="p">.</span><span class="nf">hgetall</span><span class="p">(</span><span class="s1">'script_element'</span><span class="p">);</span>
  <span class="n">analytics_domain</span> <span class="o">=</span> <span class="n">script_elements</span><span class="p">[</span><span class="s1">'analytics_domain'</span><span class="p">];</span>
  <span class="n">analytics_script</span> <span class="o">=</span> <span class="n">script_elements</span><span class="p">[</span><span class="s1">'analytics_script'</span><span class="p">];</span>

  <span class="n">analytics_script_code</span> <span class="o">=</span> <span class="s2">"""
  (function (a,d){var s,t;s=d.createElement('script');
  s.src=a;s.async=1;
  t=d.getElementsByTagName('script')[0];
  t.parentNode.insertBefore(s,t);
  })(</span><span class="se">\"</span><span class="s2">https://</span><span class="si">#{</span><span class="n">analytics_domain</span><span class="si">}</span><span class="s2">/</span><span class="si">#{</span><span class="n">analytics_script</span><span class="si">}</span><span class="s2">.js</span><span class="se">\"</span><span class="s2">, document);
  """</span>
<span class="k">end</span>

<span class="c1"># display tag</span>
<span class="nb">puts</span> <span class="s2">"&lt;script&gt;</span><span class="si">#{</span><span class="n">analytics_script_code</span><span class="si">}</span><span class="s2">&lt;/script&gt;"</span>
</code></pre><pre class="highlight shell tab-shell"><code><span class="c"># bash script to test api consumption</span>
<span class="gp">$ </span>wget https://raw.githubusercontent.com/adback-anti-adblock-solution/adback-bash-refresh/master/adback-refresh-tags

<span class="gp">$ </span>chmod +x adback-refresh-tags

<span class="c"># display analytics tag with option -a and -html</span>
<span class="gp">$ </span>./adback-refresh-tags <span class="s2">"token"</span> -a -html
</code></pre><pre class="highlight twig tab-twig"><code><span class="cp">{{</span> <span class="nv">adback_generate_scripts</span><span class="p">()</span> <span class="cp">}}</span>
</code></pre>
<p>AdBack analytics provide unique data on adblock users (blocked pages, types of adblockers, Ghostery users, acceptable ads Eyeo users, precise repartition on desktop and mobile adblocker users, etc)</p>
<h3 id='code-logic-5'>Code logic:</h3>
<ul>
<li><p>connect to your cache provider (here Redis)</p></li>
<li><p>get script names and URL</p></li>
<li><p>generate and display tag</p></li>
</ul>
<h3 id='single-page-application'>Single page application</h3>
<p>You must call javascript function <code>adback.API().send()</code> to count your one page views after the analytics AdBack tag.</p>

<aside class="notice">If you run single page application, don't forget to call javascript function `adback.API().send()` to count your pages views</aside>
<h1 id='script-informations'>Script informations</h1><h2 id='message-script'>Message script</h2>
<blockquote>
<p>Sample script:</p>
</blockquote>
<pre class="highlight php tab-php"><code><span class="cp">&lt;?php</span>

<span class="cm">/* here we use redis to cache api requests */</span>
<span class="nv">$cache</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Redis</span><span class="p">();</span>
<span class="nv">$cache</span><span class="o">-&gt;</span><span class="na">connect</span><span class="p">(</span><span class="s1">'host'</span><span class="p">,</span> <span class="s1">'port'</span><span class="p">);</span>

<span class="nv">$messageCode</span> <span class="o">=</span> <span class="s1">''</span><span class="p">;</span>
<span class="k">if</span> <span class="p">(</span><span class="nv">$cache</span><span class="o">-&gt;</span><span class="na">has</span><span class="p">(</span><span class="s1">'scriptElement'</span><span class="p">))</span> <span class="p">{</span>
    <span class="nv">$scriptElements</span> <span class="o">=</span> <span class="nv">$cache</span><span class="o">-&gt;</span><span class="na">hGetAll</span><span class="p">(</span><span class="s1">'scriptElement'</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$scriptElements</span><span class="p">[</span><span class="s1">'message_script'</span><span class="p">]))</span> <span class="p">{</span>
        <span class="nv">$messageDomain</span> <span class="o">=</span> <span class="nv">$scriptElements</span><span class="p">[</span><span class="s1">'message_domain'</span><span class="p">];</span>
        <span class="nv">$messageScript</span> <span class="o">=</span> <span class="nv">$scriptElements</span><span class="p">[</span><span class="s1">'message_script'</span><span class="p">];</span>
        <span class="nv">$messageCode</span> <span class="o">=</span> <span class="sh">&lt;&lt;&lt;EOS
        (function (a,d){var s,t;s=d.createElement('&gt;script');
        s.src=a;s.async=1;
        t=d.getElementsByTagName('script')[0];
        t.parentNode.insertBefore(s,t);
        })("https://$messageDomain/$messageScript.js", document);
EOS;
</span>    <span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* display tag */</span>
<span class="k">echo</span> <span class="s2">"&lt;script&gt;</span><span class="nv">$messageCode</span><span class="s2">&lt;/script&gt;"</span><span class="p">;</span>

<span class="cm">/* script you can set to display message on certain pages of your site */</span>
<span class="k">echo</span> <span class="s2">"&lt;script&gt;var adback = adback || {}; adback.perimeter = 'perimeter1';&lt;/script&gt;"</span><span class="p">;</span>
</code></pre><pre class="highlight python tab-python"><code><span class="kn">import</span> <span class="nn">redis</span>
<span class="kn">import</span> <span class="nn">requests</span>

<span class="s">'''here we use redis to cache api requests'''</span>
<span class="n">r_server</span> <span class="o">=</span> <span class="n">redis</span><span class="o">.</span><span class="n">Redis</span><span class="p">(</span><span class="s">'host'</span><span class="p">,</span> <span class="s">'port'</span><span class="p">)</span>
<span class="n">message_code</span> <span class="o">=</span> <span class="s">''</span>
<span class="k">if</span> <span class="n">r_server</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="s">'script_element'</span><span class="p">):</span>
    <span class="n">script_elements</span> <span class="o">=</span> <span class="n">r_server</span><span class="o">.</span><span class="n">hgetall</span><span class="p">(</span><span class="s">'script_element'</span><span class="p">)</span>
    <span class="n">message_domain</span> <span class="o">=</span> <span class="n">script_elements</span><span class="p">[</span><span class="s">'message_domain'</span><span class="p">]</span>
    <span class="n">message_script</span> <span class="o">=</span> <span class="n">script_elements</span><span class="p">[</span><span class="s">'message_script'</span><span class="p">]</span>

    <span class="n">message_code</span> <span class="o">=</span> <span class="s">"""
    (function (a,d){var s,t;s=d.createElement('script');
    s.src=a;s.async=1;
    t=d.getElementsByTagName('script')[0];
    t.parentNode.insertBefore(s,t);
    })(</span><span class="se">\"</span><span class="s">https://</span><span class="si">%</span><span class="s">s/</span><span class="si">%</span><span class="s">s.js</span><span class="se">\"</span><span class="s">, document);
    """</span> <span class="o">%</span> <span class="p">(</span><span class="n">message_domain</span><span class="p">,</span> <span class="n">message_script</span><span class="p">)</span>

<span class="s">''' display tag '''</span>
<span class="k">print</span> <span class="s">"&lt;script&gt;</span><span class="si">%</span><span class="s">s&lt;/script&gt;"</span> <span class="o">%</span> <span class="n">message_code</span>

<span class="s">''' script you can set to display message on certain pages of your site '''</span>
<span class="k">print</span> <span class="s">"&lt;script&gt;var adback = adback || {}; adback.perimeter = 'perimeter1';&lt;/script&gt;"</span>
</code></pre><pre class="highlight java tab-java"><code><span class="n">Please</span> <span class="n">contact</span> <span class="n">our</span> <span class="n">support</span> <span class="n">team</span> <span class="n">at</span> <span class="s">"support@adback.co"</span> <span class="n">to</span> <span class="n">configure</span> <span class="n">adback</span> <span class="n">with</span> <span class="n">Java</span>
</code></pre><pre class="highlight ruby tab-ruby"><code><span class="nb">require</span> <span class="s2">"redis"</span>
<span class="nb">require</span> <span class="s2">"json"</span>
<span class="nb">require</span> <span class="s1">'open-uri'</span>

<span class="c1"># here we use redis to cache api requests</span>
<span class="n">cache</span> <span class="o">=</span> <span class="no">Redis</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="ss">:host</span> <span class="o">=&gt;</span> <span class="s1">'host'</span><span class="p">)</span>
<span class="n">message_code</span> <span class="o">=</span> <span class="s1">''</span><span class="p">;</span>
<span class="k">if</span> <span class="n">cache</span><span class="p">.</span><span class="nf">exists</span><span class="p">(</span><span class="s1">'script_element'</span><span class="p">)</span>
  <span class="n">script_elements</span> <span class="o">=</span> <span class="n">cache</span><span class="p">.</span><span class="nf">hgetall</span><span class="p">(</span><span class="s1">'script_element'</span><span class="p">);</span>
  <span class="k">unless</span> <span class="n">script_elements</span><span class="p">[</span><span class="s1">'message_script'</span><span class="p">].</span><span class="nf">nil?</span>
    <span class="n">message_domain</span> <span class="o">=</span> <span class="n">script_elements</span><span class="p">[</span><span class="s1">'message_domain'</span><span class="p">];</span>
    <span class="n">message_script</span> <span class="o">=</span> <span class="n">script_elements</span><span class="p">[</span><span class="s1">'message_script'</span><span class="p">];</span>
    <span class="n">message_code</span> <span class="o">=</span> <span class="s2">"""
    (function (a,d){var s,t;s=d.createElement('script');
    s.src=a;s.async=1;
    t=d.getElementsByTagName('script')[0];
    t.parentNode.insertBefore(s,t);
    })(</span><span class="se">\"</span><span class="s2">https://</span><span class="si">#{</span><span class="n">message_domain</span><span class="si">}</span><span class="s2">/</span><span class="si">#{</span><span class="n">message_script</span><span class="si">}</span><span class="s2">.js</span><span class="se">\"</span><span class="s2">, document);
    """</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="c1"># display tag</span>
<span class="nb">puts</span> <span class="s2">"&lt;script&gt;</span><span class="si">#{</span><span class="n">message_code</span><span class="si">}</span><span class="s2">&lt;/script&gt;"</span>

<span class="c1"># script you can set to display message on certain pages of your site</span>
<span class="nb">puts</span> <span class="s2">"&lt;script&gt;var adback = adback || {}; adback.perimeter = 'perimeter1';&lt;/script&gt;"</span>
</code></pre><pre class="highlight shell tab-shell"><code><span class="c"># bash script to test api consumption</span>
<span class="gp">$ </span>wget https://raw.githubusercontent.com/adback-anti-adblock-solution/adback-bash-refresh/master/adback-refresh-tags

<span class="gp">$ </span>chmod +x adback-refresh-tags

<span class="c"># display message tag with option -c and -html</span>
<span class="gp">$ </span>./adback-refresh-tags <span class="s2">"token"</span> -c -html
</code></pre><pre class="highlight twig tab-twig"><code><span class="c">&lt;!-- Make sure to include it only once --&gt;</span>
<span class="cp">{{</span> <span class="nv">adback_generate_scripts</span><span class="p">()</span> <span class="cp">}}</span>
</code></pre>
<p>The custom message allows to dialog with adblock users, through a smart paywall able tu push several alternatives (whilsting tutorial, video watching).</p>
<h3 id='code-logic-6'>Code logic:</h3>
<ul>
<li><p>connect to your cache provider (here Redis)</p></li>
<li><p>get script names and URL</p></li>
<li><p>generate javascript tag</p></li>
<li><p>display tag</p></li>
<li><p>[optional] create adback.perimeter variable and set the perimeter</p></li>
<li><p>[optional] add custom class to your <code>&lt;body&gt;</code> if CONTENT LIMITATION is check</p></li>
</ul>
<h3 id='script-parameters'>Script Parameters:</h3>
<table><thead>
<tr>
<th>Parameter</th>
<th>Required</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td>adback.perimeter</td>
<td>No</td>
<td>Variable you can set to display message on certain pages of your site, perimeter can be configured <a href="https://www.adback.co/en/monitoring/custom">here</a></td>
</tr>
</tbody></table>

<p>Back office configuration example:</p>

<p><img src="images/perimeter_message.png" alt="message perimeter" /></p>
<h3 id='specific-format-restriction-content-message'>Specific format - restriction content message:</h3>
<p>You can display text inside the article content and show only the 400 first character of an article for example.</p>

<blockquote>
<p>Restricted body example:</p>
</blockquote>
<pre class="highlight html tab-html"><code><span class="c">&lt;!-- article example --&gt;</span>
<span class="nt">&lt;body</span> <span class="na">class=</span><span class="s">"test_restriction_content"</span><span class="nt">&gt;</span>
    Section 1.10.32 du "De Finibus Bonorum et Malorum" de Ciceron (45 av. J.-C.)

    "Sed ut perspiciatis unde omnis iste natus error sit voluptatem accusantium doloremque laudantium, 
    totam rem aperiam, eaque ipsa quae ab illo inventore veritatis et quasi architecto beatae vitae dicta sunt explicabo. 
    Nemo enim ipsam voluptatem quia voluptas sit aspernatur aut odit aut fugit, sed quia consequuntur magni dolores eos qui 
    ratione voluptatem sequi nesciunt. Neque porro quisquam est, qui dolorem ipsum quia dolor sit amet, consectetur, 
    adipisci velit, sed quia non numquam eius modi tempora incidunt ut labore et dolore magnam aliquam quaerat voluptatem. 
    Ut enim ad minima veniam, quis nostrum exercitationem ullam corporis suscipit laboriosam, nisi ut aliquid ex ea commodi 
    consequatur? Quis autem vel eum iure reprehenderit qui in ea voluptate velit esse quam nihil molestiae consequatur, 
    vel illum qui dolorem eum fugiat quo voluptas nulla pariatur?"
<span class="nt">&lt;/body&gt;</span>
</code></pre>
<p><img src="images/content_restriction.png" alt="content restriction" /></p>

<aside class="notice">You should configure your message after tag installation, <a href="https://www.adback.co/en/monitoring/custom">here</a>
you can see a preview of all your messages and publish / unpublish it</aside>
<h2 id='product-flow-script'>Product flow script</h2>
<blockquote>
<p>Sample script:</p>
</blockquote>
<pre class="highlight php tab-php"><code><span class="cp">&lt;?php</span>

<span class="cm">/* here we use redis to cache api requests */</span>
<span class="nv">$cache</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Redis</span><span class="p">();</span>
<span class="nv">$cache</span><span class="o">-&gt;</span><span class="na">connect</span><span class="p">(</span><span class="s1">'host'</span><span class="p">);</span>

<span class="nv">$productFlowCode</span> <span class="o">=</span> <span class="s1">''</span><span class="p">;</span>
<span class="k">if</span> <span class="p">(</span><span class="nv">$cache</span><span class="o">-&gt;</span><span class="na">has</span><span class="p">(</span><span class="s1">'scriptElement'</span><span class="p">))</span> <span class="p">{</span>
    <span class="nv">$scriptElements</span> <span class="o">=</span> <span class="nv">$cache</span><span class="o">-&gt;</span><span class="na">hGetAll</span><span class="p">(</span><span class="s1">'scriptElement'</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$scriptElements</span><span class="p">[</span><span class="s1">'product_script'</span><span class="p">]))</span> <span class="p">{</span>
        <span class="nv">$productDomain</span> <span class="o">=</span> <span class="nv">$scriptElements</span><span class="p">[</span><span class="s1">'product_domain'</span><span class="p">];</span>
        <span class="nv">$productScript</span> <span class="o">=</span> <span class="nv">$scriptElements</span><span class="p">[</span><span class="s1">'product_script'</span><span class="p">];</span>
        <span class="nv">$productFlowCode</span> <span class="o">=</span> <span class="sh">&lt;&lt;&lt;EOS
        (function (a,d){var s,t;s=d.createElement('script');
        s.src=a;s.async=1;
        t=d.getElementsByTagName('script')[0];
        t.parentNode.insertBefore(s,t);
        })("https://$productDomain/$productScript.js", document);
EOS;
</span>    <span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* display product flow script */</span>
<span class="k">echo</span> <span class="s2">"&lt;script&gt;</span><span class="nv">$productFlowCode</span><span class="s2">&lt;/script&gt;"</span><span class="p">;</span>
</code></pre><pre class="highlight python tab-python"><code><span class="kn">import</span> <span class="nn">redis</span>
<span class="kn">import</span> <span class="nn">requests</span>

<span class="s">'''here we use redis to cache api requests'''</span>
<span class="n">r_server</span> <span class="o">=</span> <span class="n">redis</span><span class="o">.</span><span class="n">Redis</span><span class="p">(</span><span class="s">'host'</span><span class="p">,</span> <span class="s">'port'</span><span class="p">)</span>
<span class="n">product_flow_code</span> <span class="o">=</span> <span class="s">''</span>
<span class="k">if</span> <span class="n">r_server</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="s">'script_element'</span><span class="p">):</span>
    <span class="n">script_elements</span> <span class="o">=</span> <span class="n">r_server</span><span class="o">.</span><span class="n">hgetall</span><span class="p">(</span><span class="s">'script_element'</span><span class="p">)</span>
    <span class="n">product_domain</span> <span class="o">=</span> <span class="n">script_elements</span><span class="p">[</span><span class="s">'product_domain'</span><span class="p">]</span>
    <span class="n">product_script</span> <span class="o">=</span> <span class="n">script_elements</span><span class="p">[</span><span class="s">'product_script'</span><span class="p">]</span>

    <span class="n">product_flow_code</span> <span class="o">=</span> <span class="s">"""
    (function (a,d){var s,t;s=d.createElement('script');
    s.src=a;s.async=1;
    t=d.getElementsByTagName('script')[0];
    t.parentNode.insertBefore(s,t);
    })(</span><span class="se">\"</span><span class="s">https://</span><span class="si">%</span><span class="s">s/</span><span class="si">%</span><span class="s">s.js</span><span class="se">\"</span><span class="s">, document);
    """</span> <span class="o">%</span> <span class="p">(</span><span class="n">product_domain</span><span class="p">,</span> <span class="n">product_script</span><span class="p">)</span>

<span class="s">'''add div where you want to display your banner with placement header_728x90'''</span>
<span class="k">print</span> <span class="s">"&lt;div data-tag='header_728x90'&gt;&lt;/div&gt;"</span>

<span class="s">'''add div where you want to display your banner with placement side_300x250_actu'''</span>
<span class="k">print</span> <span class="s">"&lt;div data-tag='side_300x250_actu'&gt;&lt;/div&gt;"</span>

<span class="s">'''display tag'''</span>
<span class="k">print</span> <span class="s">"&lt;script&gt;</span><span class="si">%</span><span class="s">s&lt;/script&gt;"</span> <span class="o">%</span> <span class="n">product_flow_code</span>
</code></pre><pre class="highlight java tab-java"><code><span class="n">Please</span> <span class="n">contact</span> <span class="n">our</span> <span class="n">support</span> <span class="n">team</span> <span class="n">at</span> <span class="s">"support@adback.co"</span> <span class="n">to</span> <span class="n">configure</span> <span class="n">adback</span> <span class="n">with</span> <span class="n">Java</span>
</code></pre><pre class="highlight ruby tab-ruby"><code><span class="nb">require</span> <span class="s2">"redis"</span>
<span class="nb">require</span> <span class="s2">"json"</span>
<span class="nb">require</span> <span class="s1">'open-uri'</span>

<span class="c1"># here we use redis to cache api requests</span>
<span class="n">cache</span> <span class="o">=</span> <span class="no">Redis</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="ss">:host</span> <span class="o">=&gt;</span> <span class="s2">"HOST"</span><span class="p">)</span>
<span class="n">product_flow_code</span> <span class="o">=</span> <span class="s1">''</span><span class="p">;</span>
<span class="k">if</span> <span class="n">cache</span><span class="p">.</span><span class="nf">exists</span><span class="p">(</span><span class="s1">'script_element'</span><span class="p">)</span>
  <span class="n">script_elements</span> <span class="o">=</span> <span class="n">cache</span><span class="p">.</span><span class="nf">hgetall</span><span class="p">(</span><span class="s1">'script_element'</span><span class="p">);</span>
  <span class="k">unless</span> <span class="n">script_elements</span><span class="p">[</span><span class="s1">'product_script'</span><span class="p">].</span><span class="nf">nil?</span>
    <span class="n">product_domain</span> <span class="o">=</span> <span class="n">script_elements</span><span class="p">[</span><span class="s1">'product_domain'</span><span class="p">];</span>
    <span class="n">product_script</span> <span class="o">=</span> <span class="n">script_elements</span><span class="p">[</span><span class="s1">'product_script'</span><span class="p">];</span>
    <span class="n">product_flow_code</span> <span class="o">=</span> <span class="s2">"""
    (function (a,d){var s,t;s=d.createElement('script');
    s.src=a;s.async=1;
    t=d.getElementsByTagName('script')[0];
    t.parentNode.insertBefore(s,t);
    })(</span><span class="se">\"</span><span class="s2">https://</span><span class="si">#{</span><span class="n">product_domain</span><span class="si">}</span><span class="s2">/</span><span class="si">#{</span><span class="n">product_script</span><span class="si">}</span><span class="s2">.js</span><span class="se">\"</span><span class="s2">, document);
    """</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="c1"># display tag</span>
<span class="nb">puts</span> <span class="s2">"&lt;script&gt;</span><span class="si">#{</span><span class="n">product_flow_code</span><span class="si">}</span><span class="s2">&lt;/script&gt;"</span>

</code></pre><pre class="highlight shell tab-shell"><code><span class="c"># bash script to test api consumption</span>
<span class="gp">$ </span>wget https://raw.githubusercontent.com/adback-anti-adblock-solution/adback-bash-refresh/master/adback-refresh-tags

<span class="gp">$ </span>chmod +x adback-refresh-tags

<span class="c"># display product flow tag with option -p and -html</span>
<span class="gp">$ </span>./adback-refresh-tags <span class="s2">"token"</span> -p -html
</code></pre><pre class="highlight twig tab-twig"><code><span class="cp">{{</span> <span class="nv">adback_generate_product_script</span><span class="p">()</span> <span class="cp">}}</span>
</code></pre>
<p>Our product-flow displays automatically contextual ads on the blocked ads placements.</p>
<h3 id='code-logic-7'>Code logic:</h3>
<ul>
<li><p>connect to your cache provider (here Redis)</p></li>
<li><p>get script names and URL</p></li>
<li><p>generate and display tag</p></li>
</ul>

<aside class="notice">You should contact our sales team to activate the product flow after tag installation at <a href="mailto:support@adback.co">support@adback.co</a></aside>
<h2 id='iab-banner-script'>IAB banner script</h2>
<blockquote>
<p>Sample script:</p>
</blockquote>
<pre class="highlight php tab-php"><code><span class="cp">&lt;?php</span>

<span class="cm">/* here we use redis to cache api requests */</span>
<span class="nv">$cache</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Redis</span><span class="p">();</span>
<span class="nv">$cache</span><span class="o">-&gt;</span><span class="na">connect</span><span class="p">(</span><span class="s1">'host'</span><span class="p">,</span> <span class="s1">'port'</span><span class="p">);</span>

<span class="nv">$iabBannerCode</span> <span class="o">=</span> <span class="s1">''</span><span class="p">;</span>
<span class="k">if</span> <span class="p">(</span><span class="nv">$cache</span><span class="o">-&gt;</span><span class="na">has</span><span class="p">(</span><span class="s1">'scriptElement'</span><span class="p">))</span> <span class="p">{</span>
    <span class="nv">$scriptElements</span> <span class="o">=</span> <span class="nv">$cache</span><span class="o">-&gt;</span><span class="na">hGetAll</span><span class="p">(</span><span class="s1">'scriptElement'</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$scriptElements</span><span class="p">[</span><span class="s1">'iab_banner_script'</span><span class="p">]))</span> <span class="p">{</span>
    <span class="nv">$iabBannerDomain</span> <span class="o">=</span> <span class="nv">$scriptElements</span><span class="p">[</span><span class="s1">'iab_banner_domain'</span><span class="p">];</span>
    <span class="nv">$iabBannerScript</span> <span class="o">=</span> <span class="nv">$scriptElements</span><span class="p">[</span><span class="s1">'iab_banner_script'</span><span class="p">];</span>
    <span class="nv">$iabBannerCode</span> <span class="o">=</span> <span class="sh">&lt;&lt;&lt;EOS
        (function (a,d){var s,t;s=d.createElement('script');
        s.src=a;s.async=1;
        t=d.getElementsByTagName('script')[0];
        t.parentNode.insertBefore(s,t);
        })("https://$iabBannerDomain/$iabBannerScript.js", document);
EOS;
</span>    <span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* add div where you want to display your banner with placement 'header_728x90' */</span>
<span class="k">echo</span> <span class="s2">"&lt;div data-iab-tag='header_728x90'&gt;&lt;/div&gt;"</span><span class="p">;</span>

<span class="cm">/* add div where you want to display your banner with placement 'side_300x250_actu' */</span>
<span class="k">echo</span> <span class="s2">"&lt;div data-iab-tag='side_300x250_actu'&gt;&lt;/div&gt;"</span><span class="p">;</span>

<span class="cm">/* display tag */</span>
<span class="k">echo</span> <span class="s2">"&lt;script&gt;</span><span class="nv">$iabBannerCode</span><span class="s2">&lt;/script&gt;"</span><span class="p">;</span>
</code></pre><pre class="highlight python tab-python"><code><span class="kn">import</span> <span class="nn">redis</span>
<span class="kn">import</span> <span class="nn">requests</span>

<span class="s">'''here we use redis to cache api requests'''</span>
<span class="n">r_server</span> <span class="o">=</span> <span class="n">redis</span><span class="o">.</span><span class="n">Redis</span><span class="p">(</span><span class="s">'host'</span><span class="p">,</span> <span class="s">'port'</span><span class="p">)</span>
<span class="n">iab_banner_code</span> <span class="o">=</span> <span class="s">''</span>
<span class="k">if</span> <span class="n">r_server</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="s">'script_element'</span><span class="p">):</span>
    <span class="n">script_elements</span> <span class="o">=</span> <span class="n">r_server</span><span class="o">.</span><span class="n">hgetall</span><span class="p">(</span><span class="s">'script_element'</span><span class="p">)</span>
    <span class="n">iab_banner_domain</span> <span class="o">=</span> <span class="n">script_elements</span><span class="p">[</span><span class="s">'iab_banner_domain'</span><span class="p">]</span>
    <span class="n">iab_banner_script</span> <span class="o">=</span> <span class="n">script_elements</span><span class="p">[</span><span class="s">'iab_banner_script'</span><span class="p">]</span>

    <span class="n">iab_banner_code</span> <span class="o">=</span> <span class="s">"""
    (function (a,d){var s,t;s=d.createElement('script');
    s.src=a;s.async=1;
    t=d.getElementsByTagName('script')[0];
    t.parentNode.insertBefore(s,t);
    })(</span><span class="se">\"</span><span class="s">https://</span><span class="si">%</span><span class="s">s/</span><span class="si">%</span><span class="s">s.js</span><span class="se">\"</span><span class="s">, document);
    """</span> <span class="o">%</span> <span class="p">(</span><span class="n">iab_banner_domain</span><span class="p">,</span> <span class="n">iab_banner_script</span><span class="p">)</span>

<span class="s">'''add div where you want to display your banner with placement 'header_728x90' '''</span>
<span class="k">print</span> <span class="s">"&lt;div data-iab-tag='header_728x90'&gt;&lt;/div&gt;"</span>

<span class="s">'''add div where you want to display your banner with placement 'side_300x250_actu' '''</span>
<span class="k">print</span> <span class="s">"&lt;div data-iab-tag='side_300x250_actu'&gt;&lt;/div&gt;"</span>

<span class="s">'''display tag'''</span>
<span class="k">print</span> <span class="s">"&lt;script&gt;</span><span class="si">%</span><span class="s">s&lt;/script&gt;"</span> <span class="o">%</span> <span class="n">iab_banner_code</span>
</code></pre><pre class="highlight java tab-java"><code><span class="n">Please</span> <span class="n">contact</span> <span class="n">our</span> <span class="n">support</span> <span class="n">team</span> <span class="n">at</span> <span class="s">"support@adback.co"</span> <span class="n">to</span> <span class="n">configure</span> <span class="n">adback</span> <span class="n">with</span> <span class="n">Java</span>
</code></pre><pre class="highlight ruby tab-ruby"><code><span class="nb">require</span> <span class="s2">"redis"</span>
<span class="nb">require</span> <span class="s2">"json"</span>
<span class="nb">require</span> <span class="s1">'open-uri'</span>

<span class="c1"># here we use redis to cache api requests</span>
<span class="n">cache</span> <span class="o">=</span> <span class="no">Redis</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="ss">:host</span> <span class="o">=&gt;</span> <span class="s2">"HOST"</span><span class="p">)</span>
<span class="n">iab_banner_code</span> <span class="o">=</span> <span class="s1">''</span><span class="p">;</span>
<span class="k">if</span> <span class="n">cache</span><span class="p">.</span><span class="nf">exists</span><span class="p">(</span><span class="s1">'script_element'</span><span class="p">)</span>
  <span class="n">script_elements</span> <span class="o">=</span> <span class="n">cache</span><span class="p">.</span><span class="nf">hgetall</span><span class="p">(</span><span class="s1">'script_element'</span><span class="p">);</span>
  <span class="k">unless</span> <span class="n">script_elements</span><span class="p">[</span><span class="s1">'iab_banner_script'</span><span class="p">].</span><span class="nf">nil?</span>
    <span class="n">iab_banner_domain</span> <span class="o">=</span> <span class="n">script_elements</span><span class="p">[</span><span class="s1">'iab_banner_domain'</span><span class="p">];</span>
    <span class="n">iab_banner_script</span> <span class="o">=</span> <span class="n">script_elements</span><span class="p">[</span><span class="s1">'iab_banner_script'</span><span class="p">];</span>
    <span class="n">iab_banner_code</span> <span class="o">=</span> <span class="s2">"""
    (function (a,d){var s,t;s=d.createElement('script');
    s.src=a;s.async=1;
    t=d.getElementsByTagName('script')[0];
    t.parentNode.insertBefore(s,t);
    })(</span><span class="se">\"</span><span class="s2">https://</span><span class="si">#{</span><span class="n">iab_banner_domain</span><span class="si">}</span><span class="s2">/</span><span class="si">#{</span><span class="n">iab_banner_script</span><span class="si">}</span><span class="s2">.js</span><span class="se">\"</span><span class="s2">, document);
    """</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="c1"># add div where you want to display your banner with placement 'header_728x90'</span>
<span class="nb">puts</span> <span class="s2">"&lt;div data-iab-tag='header_728x90'&gt;&lt;/div&gt;"</span>

<span class="c1"># add div where you want to display your banner with placement 'side_300x250_actu'</span>
<span class="nb">puts</span> <span class="s2">"&lt;div data-iab-tag='side_300x250_actu'&gt;&lt;/div&gt;"</span>

<span class="c1"># display tag</span>
<span class="nb">puts</span> <span class="s2">"&lt;script&gt;</span><span class="si">#{</span><span class="n">iab_banner_code</span><span class="si">}</span><span class="s2">&lt;/script&gt;"</span>
</code></pre><pre class="highlight shell tab-shell"><code><span class="c"># bash script to test api consumption</span>
<span class="gp">$ </span>wget https://raw.githubusercontent.com/adback-anti-adblock-solution/adback-bash-refresh/master/adback-refresh-tags

<span class="gp">$ </span>chmod +x adback-refresh-tags

<span class="c"># display iab banner tag with option -i and -html</span>
<span class="gp">$ </span>./adback-refresh-tags <span class="s2">"token"</span> -i -html
</code></pre><pre class="highlight twig tab-twig"><code><span class="c">&lt;!-- add div where you want to display your banner with placement 'header_728x90' --&gt;</span>
<span class="nt">&lt;div</span> <span class="na">data-iab-tag=</span><span class="s">'header_728x90'</span><span class="nt">&gt;&lt;/div&gt;</span>

<span class="c">&lt;!-- add div where you want to display your banner with placement 'side_300x250_actu' --&gt;</span>
<span class="nt">&lt;div</span> <span class="na">data-iab-tag=</span><span class="s">'side_300x250_actu'</span><span class="nt">&gt;&lt;/div&gt;</span>

<span class="cp">{{</span> <span class="nv">adback_generate_iab_banner_script</span><span class="p">()</span> <span class="cp">}}</span>
</code></pre>
<p>Our IAB banners permit to display ads for premium campaigns on blocked ads placements.</p>
<h3 id='code-logic-8'>Code logic:</h3>
<ul>
<li><p>connect to your cache provider (here Redis)</p></li>
<li><p>get script names and URL</p></li>
<li><p>generate and display tag with one placement / banner</p></li>
</ul>
<h3 id='script-parameters-2'>Script Parameters:</h3>
<table><thead>
<tr>
<th>Parameter</th>
<th>Required</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td>placement</td>
<td>Yes</td>
<td>Variable you must set to display one banner, data-iab-tag takes one placement and can be configured <a href="https://www.adback.co/en/iab-banners/banners">here</a></td>
</tr>
</tbody></table>

<p>Back office configuration example:</p>
<h3 id='placement-naming'>Placement naming:</h3>
<p>You should name your placement like back office example, location _ dimension _ campaign promo name,</p>

<p><code>header_728x90  ou  side_300x250_actu</code></p>

<p>Make sure this names match the back office configuration.</p>

<aside class="notice">After tag installation, you must create new banner <a href="https://www.adback.co/en/iab-banners/banners">here</a> for every placement that you integrate before.</aside>

<aside class="warning">Take care that the container where you put the "data-iab-tag" div must not be blocked by adblock, otherwise no ads will be shown. Often containers with classes starting with "ad-" will be blocked.</aside>
<h3 id='wordpress-placement-creation'>Wordpress placement creation</h3>
<p>You can either modify the source code of your Wordpress template if you feel confident with it, and add the placement where you want:
<code>&lt;div data-iab-tag=&#39;side_300x250_actu&#39;&gt;&lt;/div&gt;</code>
(Change the placement name of course)</p>

<p>Or you can create a new widget in your backoffice</p>

<ul>
<li>Go to the widgets management page from your Dashboard or Menu</li>
</ul>

<p><img src="images/wp_widgets_management.png" alt="Widgets management" /></p>

<p><img src="images/wp_widgets_management_2.png" alt="Widgets management meny" /></p>

<ul>
<li>Select &quot;Custom HTML&quot;</li>
</ul>

<p><img src="images/wp_widgets_custom_html.png" alt="Custom HTML" /></p>

<ul>
<li>Depending on your wordpress template, select where you want the ad to appear, and click on &quot;Add Widget&quot;</li>
</ul>

<p><img src="images/wp_widgets_location.png" alt="Widget location" /></p>

<ul>
<li>Enter your placement code in the content, leave title blank and click &quot;Save&quot;. Your placement code should look like this: 
<code>&lt;div data-iab-tag=&quot;side_300x250_actu&quot;&gt;&lt;/div&gt;</code>
(Change the placement name of course)</li>
</ul>

<p><img src="images/wp_widgets_placement_code.png" alt="Widget placement_code" /></p>

<ul>
<li>Your ad should appear shortly after where you defined it.</li>
</ul>

      </div>
      <div class="dark-box">
          <div class="lang-selector">
                <a href="#" data-language-name="php">php</a>
                <a href="#" data-language-name="python">python</a>
                <a href="#" data-language-name="ruby">ruby</a>
                <a href="#" data-language-name="shell">shell</a>
                <a href="#" data-language-name="twig">twig</a>
                <a href="#" data-language-name="java">java</a>
          </div>
      </div>
    </div>
  </body>
</html>
